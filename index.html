<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit the Odds</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc; /* Slate 50 */
            --container-bg: #ffffff; /* White */
            --text-primary: #0f172a; /* Slate 900 */
            --text-secondary: #475569; /* Slate 600 */
            --border-color: #e2e8f0; /* Slate 200 */
            --input-bg: #f1f5f9; /* Slate 100 */
            --header-bg-light: hsla(0, 0%, 100%, 0.7);
            --accent-color: #2563eb; /* Blue 600 */
            --accent-color-light: #eff6ff; /* Blue 50 */
            --accent-text-dark: #1e40af; /* Blue 800 */
            --positive-bg: #f0fdf4; /* Green 50 */
            --positive-text: #15803d; /* Green 700 */
            --positive-border: #bbf7d0; /* Green 300 */
            --negative-bg: #fef2f2; /* Red 50 */
            --negative-text: #b91c1c; /* Red 700 */
            --negative-border: #fecaca; /* Red 300 */
        }
        html.dark {
            --bg-color: #020617; /* Slate 950 */
            --container-bg: #0f172a; /* Slate 900 */
            --text-primary: #f1f5f9; /* Slate 100 */
            --text-secondary: #64748b; /* Slate 500 */
            --border-color: #1e293b; /* Slate 800 */
            --input-bg: #1e293b;
            --header-bg-light: hsla(222, 47%, 11%, 0.7);
            --accent-color: #3b82f6; /* Blue 500 */
            --accent-color-light: #1e293b; /* A darker blue-ish slate */
            --accent-text-dark: #93c5fd; /* Blue 300 */
            --positive-bg: #111827; /* Gray 900 */
            --positive-text: #4ade80; /* Green 400 */
            --positive-border: #166534; /* Green 800 */
            --negative-bg: #111827; /* Gray 900 */
            --negative-text: #f87171; /* Red 400 */
            --negative-border: #991b1b; /* Red 800 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        header {
            position: sticky;
            top: 1rem;
            z-index: 10;
            background-color: var(--header-bg-light);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 1.5rem;
            border-radius: 1.25rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            position: relative; /* Added for canvas positioning */
            overflow: hidden; /* Ensures canvas corners are clipped */
        }
        html.dark header {
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        #theme-toggle { position: absolute; top: 1rem; right: 1rem; }
        #help-btn { position: absolute; top: 1rem; left: 1rem; }
        
        .game-card {
            background-color: var(--container-bg);
            border-radius: 1.25rem;
            padding: 1.5rem;
            box-shadow: 0 6px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        .game-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
        }
        html.dark .game-card { box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        html.dark .game-card:hover { box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        
        .result-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-weight: 500;
            border: 1px solid;
            background-color: var(--positive-bg);
        }
        .positive-ev { color: var(--positive-text); border-color: var(--positive-border); }
        .negative-ev { color: var(--negative-text); border-color: var(--negative-border); }
        
        .spinner { animation: rotate 1s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Custom Slider & Input Styles */
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; width: 100%; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { background: var(--input-bg); height: 0.75rem; border-radius: 1rem; border: 1px solid var(--border-color); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -0.6rem; background-color: var(--accent-color); height: 1.75rem; width: 1.75rem; border-radius: 50%; border: 5px solid var(--container-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input[type=range]::-moz-range-track { background: var(--input-bg); height: 0.75rem; border-radius: 1rem; border: 1px solid var(--border-color); }
        input[type=range]::-moz-range-thumb { background-color: var(--accent-color); height: 1.75rem; width: 1.75rem; border-radius: 50%; border: 5px solid var(--container-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .prob-input { background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 0.375rem; text-align: center; width: 70px; font-weight: 600; padding: 0.25rem; }
        .prob-input:focus { outline: 2px solid var(--accent-color); }

        .utility-btn { background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 500; transition: all 0.2s; }
        .utility-btn:hover:not(:disabled) { background-color: var(--accent-color-light); border-color: var(--accent-color); color: var(--accent-text-dark); }
        .utility-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Modal Styles */
        #help-modal, #parlay-modal, #combo-modal { transition: opacity 0.3s; }
        #help-modal-content, #parlay-modal-content, #combo-modal-content { transition: transform 0.3s; }

        /* Summary Dashboard */
        .stat-card {
            background-color: var(--container-bg);
            padding: 1rem;
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.04);
        }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto"> <!-- Increased max-width for side-by-side layout -->
        <header>
            <canvas id="matrix-canvas" class="absolute top-0 left-0 w-full h-full z-0"></canvas>
            <div class="relative z-10"> <!-- Added wrapper for content -->
                <button id="theme-toggle" class="p-2 rounded-full focus:outline-none" style="color: var(--text-secondary); background-color: var(--bg-color); border: 1px solid var(--border-color);">
                    <svg id="theme-icon-light" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
                <button id="help-btn" class="p-2 rounded-full focus:outline-none" style="color: var(--text-secondary); background-color: var(--bg-color); border: 1px solid var(--border-color);">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                </button>
                <div class="text-center">
                    <h1 class="text-4xl md:text-5xl font-extrabold mb-2">Audit the Odds <span class="text-lg align-middle font-medium text-secondary">v6.0</span></h1>
                    <p class="text-lg text-secondary">Find value by analyzing live betting lines.</p>
                </div>
            </div>
        </header>

        <main class="mt-8">
            <!-- Main Action Button -->
            <div id="analyze-section" class="text-center my-12">
                <button id="analyze-today-btn" class="text-xl font-semibold py-4 px-10 rounded-xl transition-transform transform hover:scale-105 shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-offset-2" style="background-color: var(--accent-color); color: white; focus-ring-color: var(--accent-color)">
                    Analyze Today's Games
                </button>
            </div>

            <div id="processingState" class="hidden text-center py-10">
                <svg class="spinner h-8 w-8 mx-auto" style="color: var(--accent-color);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p id="processing-text" class="mt-4 text-secondary">Fetching the latest odds... this may take a moment.</p>
            </div>

            <div id="errorState" class="hidden text-center p-4 rounded-lg" style="background-color: var(--negative-bg); color: var(--negative-text);"></div>
            
             <div id="main-content-area" class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">
                <div id="results-area" class="hidden lg:col-span-2">
                     <!-- Summary Dashboard -->
                    <div id="summary-dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center"></div>

                     <!-- Strategy Controls -->
                    <div id="strategy-controls" class="hidden mb-6 p-4 rounded-xl" style="background-color: var(--container-bg); border: 1px solid var(--border-color);">
                        <h3 class="text-lg font-semibold mb-3 text-center">Parlay Strategy</h3>
                        <div id="strategy-options" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"></div>
                        <div class="text-center">
                            <button id="generate-parlay-btn" class="text-base font-semibold py-2 px-6 rounded-lg flex items-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed mx-auto" style="background-color: #16a34a; color: white;" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span id="parlay-btn-text">Apply Strategy & Copy Parlay</span>
                            </button>
                        </div>
                    </div>

                    <!-- Filter and Sort Controls -->
                    <div id="filter-controls" class="mb-4 p-4 rounded-xl flex flex-col sm:flex-row flex-wrap items-center justify-between gap-4" style="background-color: var(--container-bg); border: 1px solid var(--border-color);">
                        <div class="flex items-center space-x-3">
                            <label for="ev-filter-toggle" class="text-sm font-medium whitespace-nowrap">Show +EV Only</label>
                            <label for="ev-filter-toggle" class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" id="ev-filter-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="sort-select" class="text-sm font-medium">Sort By:</label>
                            <select id="sort-select" class="text-sm rounded-md p-1" style="background-color: var(--input-bg); border: 1px solid var(--border-color);">
                                <option value="default">Default Order</option>
                                <option value="highest-ev">Highest EV</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="add-best-ev-btn" class="text-sm font-semibold py-2 px-4 rounded-lg flex items-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: #16a34a; color: white;" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z" clip-rule="evenodd" /></svg>
                                <span id="add-best-ev-btn-text">Add Best +EV Bets</span>
                            </button>
                            <button id="copy-btn" class="text-sm font-semibold py-2 px-4 rounded-lg flex items-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: var(--accent-color); color: white;" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                <span id="copy-btn-text">Copy +EV Games</span>
                            </button>
                            <button id="new-analysis-btn" class="utility-btn text-sm py-2 px-4 rounded-lg flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M13.5 4.432a.75.75 0 01.068 1.056l-3.25 4.5a.75.75 0 01-1.139.009l-1.75-2.003a.75.75 0 111.122-1.004l1.18 1.348 2.72-3.778a.75.75 0 011.056-.068z" clip-rule="evenodd" /></svg>
                                New Analysis
                            </button>
                        </div>
                    </div>
                    <div id="game-list-container" class="grid grid-cols-1 gap-6"></div>
                </div>

                <!-- Bet Slip Area -->
                <div id="bet-slip-area" class="hidden lg:block lg:col-span-1 sticky top-32 self-start">
                    <div class="p-4 rounded-xl" style="background-color: var(--container-bg); border: 1px solid var(--border-color);">
                        <h3 class="text-lg font-semibold mb-3 text-center">My Bet Slip</h3>
                        <div id="bet-slip-list" class="space-y-2 max-h-[60vh] overflow-y-auto">
                            <!-- Selected bets will appear here -->
                        </div>
                        <div id="bet-slip-controls" class="mt-4 flex flex-col gap-2 hidden">
                            <button id="copy-slip-btn" class="text-sm font-semibold py-2 px-4 rounded-lg flex items-center justify-center transition-colors" style="background-color: var(--accent-color); color: white;">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                <span id="copy-slip-btn-text">Copy Slip</span>
                            </button>
                            <button id="combo-analysis-btn" class="utility-btn text-sm w-full" disabled>Round Robin Analysis</button>
                            <button id="clear-slip-btn" class="utility-btn text-sm w-full">Clear Slip</button>
                        </div>
                         <p id="empty-slip-message" class="text-center text-sm text-secondary py-4">Click on a bet to add it to your slip.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4 opacity-0">
        <div id="help-modal-content" class="w-full max-w-2xl p-6 md:p-8 rounded-2xl shadow-2xl transform scale-95" style="background-color: var(--container-bg); border: 1px solid var(--border-color);">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">How It Works</h3>
                <button id="close-help-modal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="text-secondary space-y-4">
                <p><strong>1. Analyze Games:</strong> Click the "Analyze Today's Games" button. The app will automatically fetch the latest odds for available sports using The Odds API.</p>
                <p><strong>2. Adjust Probabilities:</strong> For each game, the app shows the "implied probability" from the sportsbook's odds. Use the slider or type in the input box to adjust this to what you believe the <span class="font-semibold text-primary">true probability</span> is.</p>
                <p><strong>3. Find +EV:</strong> The app instantly calculates the <strong>Expected Value (EV)</strong> for each bet based on your probability. A positive EV (+EV) indicates a potentially profitable bet in the long run if your probability assessment is more accurate than the sportsbook's.</p>
                <p><strong>4. Build a Slip:</strong> Click on any bet to add it to your Bet Slip. From there you can copy your picks or use the new Round Robin Analysis tool to explore combo betting profitability.</p>
            </div>
        </div>
    </div>
    <!-- Parlay Modal -->
    <div id="parlay-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4 opacity-0">
        <div id="parlay-modal-content" class="w-full max-w-lg p-6 md:p-8 rounded-2xl shadow-2xl transform scale-95" style="background-color: var(--container-bg); border: 1px solid var(--border-color);">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Generated Parlay Picks</h3>
                <button id="close-parlay-modal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="parlay-list-container" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                <!-- Parlay picks will be inserted here -->
            </div>
            <div id="parlay-rationale-section" class="mt-4">
                <button id="generate-rationale-btn" class="utility-btn text-sm w-full flex items-center justify-center">
                    ✨ Generate Parlay Rationale
                </button>
                <div id="parlay-rationale-container" class="text-sm text-secondary mt-3 p-3 rounded-lg" style="background-color: var(--input-bg); display: none;">
                    <!-- AI rationale will be loaded here -->
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                 <button id="cancel-parlay-btn" class="utility-btn text-sm py-2 px-4 rounded-lg">Cancel</button>
                 <button id="copy-parlay-btn" class="text-sm font-semibold py-2 px-4 rounded-lg flex items-center transition-colors" style="background-color: var(--accent-color); color: white;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    <span id="copy-parlay-btn-text">Copy & Close</span>
                </button>
            </div>
        </div>
    </div>
    <!-- Round Robin Combo Modal -->
    <div id="combo-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4 opacity-0">
        <div id="combo-modal-content" class="w-full max-w-2xl p-6 md:p-8 rounded-2xl shadow-2xl transform scale-95" style="background-color: var(--container-bg); border: 1px solid var(--border-color);">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Round Robin Profitability Analysis</h3>
                <button id="close-combo-modal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="space-y-4">
               <p class="text-sm text-secondary">This tool estimates the number of wins you need for different round robin combinations to become profitable, based on the <strong>average odds</strong> of the bets in your slip. This is an estimate, as actual payouts depend on which specific games you win.</p>
               <div class="flex items-center space-x-4 p-3 rounded-lg" style="background-color: var(--input-bg);">
                   <div class="flex-1">
                       <label for="wager-per-combo" class="block text-sm font-medium">Wager per Combination ($)</label>
                       <input type="number" id="wager-per-combo" value="1" min="0.01" step="0.01" class="w-full p-2 rounded-md mt-1" style="background-color: var(--container-bg); border: 1px solid var(--border-color);">
                   </div>
                   <div class="text-center">
                        <div class="text-sm font-medium">Total Games</div>
                        <div id="combo-total-games" class="text-2xl font-bold">0</div>
                   </div>
                   <div class="text-center">
                        <div class="text-sm font-medium">Average Odds</div>
                        <div id="combo-avg-odds" class="text-2xl font-bold">0.00</div>
                   </div>
               </div>
               <div id="combo-results-container" class="max-h-80 overflow-y-auto pr-2">
                   <!-- Results table will be generated here -->
               </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gameListContainer = document.getElementById('game-list-container');
            const processingState = document.getElementById('processingState');
            const processingText = document.getElementById('processing-text');
            const errorState = document.getElementById('errorState');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIconLight = document.getElementById('theme-icon-light');
            const themeIconDark = document.getElementById('theme-icon-dark');
            const resultsArea = document.getElementById('results-area');
            const filterControls = document.getElementById('filter-controls');
            const evFilterToggle = document.getElementById('ev-filter-toggle');
            const sortSelect = document.getElementById('sort-select');
            const copyBtn = document.getElementById('copy-btn');
            const copyBtnText = document.getElementById('copy-btn-text');
            const addBestEvBtn = document.getElementById('add-best-ev-btn');
            const analyzeSection = document.getElementById('analyze-section');
            const analyzeTodayBtn = document.getElementById('analyze-today-btn');
            const strategyControls = document.getElementById('strategy-controls');
            const strategyOptionsContainer = document.getElementById('strategy-options');
            const generateParlayBtn = document.getElementById('generate-parlay-btn');
            const parlayBtnText = document.getElementById('parlay-btn-text');
            const newAnalysisBtn = document.getElementById('new-analysis-btn');
            const helpBtn = document.getElementById('help-btn');
            const helpModal = document.getElementById('help-modal');
            const helpModalContent = document.getElementById('help-modal-content');
            const closeHelpModalBtn = document.getElementById('close-help-modal');
            const summaryDashboard = document.getElementById('summary-dashboard');
            const parlayModal = document.getElementById('parlay-modal');
            const parlayModalContent = document.getElementById('parlay-modal-content');
            const closeParlayModalBtn = document.getElementById('close-parlay-modal');
            const cancelParlayBtn = document.getElementById('cancel-parlay-btn');
            const parlayListContainer = document.getElementById('parlay-list-container');
            const copyParlayBtn = document.getElementById('copy-parlay-btn');
            const copyParlayBtnText = document.getElementById('copy-parlay-btn-text');
            const generateRationaleBtn = document.getElementById('generate-rationale-btn');
            const parlayRationaleContainer = document.getElementById('parlay-rationale-container');
            const betSlipArea = document.getElementById('bet-slip-area');
            const betSlipList = document.getElementById('bet-slip-list');
            const betSlipControls = document.getElementById('bet-slip-controls');
            const emptySlipMessage = document.getElementById('empty-slip-message');
            const copySlipBtn = document.getElementById('copy-slip-btn');
            const copySlipBtnText = document.getElementById('copy-slip-btn-text');
            const clearSlipBtn = document.getElementById('clear-slip-btn');
            
            // New Combo Modal Elements
            const comboAnalysisBtn = document.getElementById('combo-analysis-btn');
            const comboModal = document.getElementById('combo-modal');
            const comboModalContent = document.getElementById('combo-modal-content');
            const closeComboModalBtn = document.getElementById('close-combo-modal');
            const wagerPerComboInput = document.getElementById('wager-per-combo');
            const comboTotalGames = document.getElementById('combo-total-games');
            const comboAvgOdds = document.getElementById('combo-avg-odds');
            const comboResultsContainer = document.getElementById('combo-results-container');


            let ALL_SPORTS_DATA = [];
            let gameCardElements = [];
            let betSlip = [];

            // --- Hardcoded API Keys ---
            const oddsApiKey = 'cc51a757d14174fd8061956b288df39e';
			const geminiApiKey = 'REPLACE_WITH_YOUR_API_KEY';

            // --- THEME SWITCHER ---
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    themeIconLight.classList.add('hidden');
                    themeIconDark.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    themeIconLight.classList.remove('hidden');
                    themeIconDark.classList.add('hidden');
                }
            };
            themeToggle.addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));

            // --- Matrix Effect ---
            const canvas = document.getElementById('matrix-canvas');
            const ctx = canvas.getContext('2d');
            const headerElement = canvas.closest('header');

            let animationFrameId;

            function setupMatrix() {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }

                const dpr = window.devicePixelRatio || 1;
                canvas.width = headerElement.offsetWidth * dpr;
                canvas.height = headerElement.offsetHeight * dpr;
                ctx.scale(dpr, dpr);

                const characters = '0123456789$+-*/=';
                const fontSize = 14;
                const columns = Math.floor(headerElement.offsetWidth / fontSize);
                const drops = [];

                for (let x = 0; x < columns; x++) {
                    drops[x] = 1;
                }

                function draw() {
                    ctx.fillStyle = document.documentElement.classList.contains('dark') ? 'rgba(15, 23, 42, 0.15)' : 'rgba(255, 255, 255, 0.15)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.fillStyle = document.documentElement.classList.contains('dark') ? '#3b82f6' : '#2563eb';
                    ctx.font = `${fontSize}px Inter, monospace`;

                    for (let i = 0; i < drops.length; i++) {
                        const text = characters.charAt(Math.floor(Math.random() * characters.length));
                        ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                        if (drops[i] * fontSize > headerElement.offsetHeight && Math.random() > 0.975) {
                            drops[i] = 0;
                        }
                        drops[i]++;
                    }
                    animationFrameId = requestAnimationFrame(draw);
                }
                draw();
            }

            // Initial setup
            setTimeout(setupMatrix, 100); // Small delay to ensure header has dimensions

            // Re-run on resize
            new ResizeObserver(setupMatrix).observe(headerElement);
            themeToggle.addEventListener('click', () => {
                 setTimeout(setupMatrix, 100);
            });


            // --- TEAM & SPORT DATA ---
            const TEAMS_DATA = { 'BOS': { name: 'Boston Red Sox', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/bos.png' }, 'CHC': { name: 'Chicago Cubs', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/chc.png' }, 'CWS': { name: 'Chicago White Sox', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/chw.png' }, 'PIT': { name: 'Pittsburgh Pirates', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/pit.png' }, 'SD': { name: 'San Diego Padres', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/sd.png' }, 'WSH': { name: 'Washington Nationals', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/wsh.png' }, 'LAA': { name: 'Los Angeles Angels', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/laa.png' }, 'PHI': { name: 'Philadelphia Phillies', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/phi.png' }, 'SF': { name: 'San Francisco Giants', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/sf.png' }, 'TOR': { name: 'Toronto Blue Jays', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/tor.png' }, 'NYY': { name: 'New York Yankees', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/nyy.png' }, 'ATL': { name: 'Atlanta Braves', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/atl.png' }, 'MIL': { name: 'Milwaukee Brewers', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/mil.png' }, 'LAD': { name: 'Los Angeles Dodgers', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/lad.png' }, 'HOU': { name: 'Houston Astros', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/hou.png' }, 'SEA': { name: 'Seattle Mariners', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/sea.png' }, 'CIN': { name: 'Cincinnati Reds', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/cin.png' }, 'STL': { name: 'St. Louis Cardinals', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/stl.png' }, 'TB': { name: 'Tampa Bay Rays', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/tb.png' }, 'BAL': { name: 'Baltimore Orioles', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/bal.png' }, 'CLE': { name: 'Cleveland Guardians', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/cle.png' }, 'MIN': { name: 'Minnesota Twins', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/min.png' }, 'KC': { name: 'Kansas City Royals', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/kc.png' }, 'DET': { name: 'Detroit Tigers', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/det.png' }, 'TEX': { name: 'Texas Rangers', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/tex.png' }, 'OAK': { name: 'Oakland Athletics', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/oak.png' }, 'NYM': { name: 'New York Mets', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/nym.png' }, 'MIA': { name: 'Miami Marlins', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/mia.png' }, 'ARI': { name: 'Arizona Diamondbacks', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/ari.png' }, 'COL': { name: 'Colorado Rockies', logo: 'https://a.espncdn.com/i/teamlogos/mlb/500/col.png' }, 'CFL-HAM': { name: 'Hamilton Tiger-Cats', logo: 'https://upload.wikimedia.org/wikipedia/en/8/87/Hamilton_Tiger-Cats_logo.svg' }, 'CFL-CGY': { name: 'Calgary Stampeders', logo: 'https://upload.wikimedia.org/wikipedia/en/b/b8/Calgary_Stampeders_logo.svg' }, 'CFL-TOR': { name: 'Toronto Argonauts', logo: 'https://upload.wikimedia.org/wikipedia/en/e/e1/Toronto_Argonauts_logo.svg' }, 'CFL-SSK': { name: 'Saskatchewan Roughriders', logo: 'https://upload.wikimedia.org/wikipedia/en/thumb/5/5c/Saskatchewan_Roughriders_logo.svg/100px-Saskatchewan_Roughriders_logo.svg.png' }, 'CFL-BC': { name: 'BC Lions', logo: 'https://upload.wikimedia.org/wikipedia/en/3/3f/BC_Lions_Logo.svg' }, 'CFL-EDM': { name: 'Edmonton Elks', logo: 'https://upload.wikimedia.org/wikipedia/en/thumb/1/1a/Edmonton_Elks_logo.svg/100px-Edmonton_Elks_logo.svg.png' }, 'CFL-WPG': { name: 'Winnipeg Blue Bombers', logo: 'https://upload.wikimedia.org/wikipedia/en/thumb/0/04/Winnipeg_Blue_Bombers_logo.svg/100px-Winnipeg_Blue_Bombers_logo.svg.png' }, 'CFL-MTL': { name: 'Montreal Alouettes', logo: 'https://upload.wikimedia.org/wikipedia/en/2/2f/Montreal_Alouettes_logo.svg' }, 'CFL-OTT': { name: 'Ottawa Redblacks', logo: 'https://upload.wikimedia.org/wikipedia/en/thumb/f/f7/Ottawa_Redblacks_logo.svg/100px-Ottawa_Redblacks_logo.svg.png' }, 'NFL-ARI': { name: 'Arizona Cardinals', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/ari.png' }, 'NFL-ATL': { name: 'Atlanta Falcons', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/atl.png' }, 'NFL-BAL': { name: 'Baltimore Ravens', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/bal.png' }, 'NFL-BUF': { name: 'Buffalo Bills', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/buf.png' }, 'NFL-CAR': { name: 'Carolina Panthers', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/car.png' }, 'NFL-CHI': { name: 'Chicago Bears', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/chi.png' }, 'NFL-CIN': { name: 'Cincinnati Bengals', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/cin.png' }, 'NFL-CLE': { name: 'Cleveland Browns', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/cle.png' }, 'NFL-DAL': { name: 'Dallas Cowboys', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/dal.png' }, 'NFL-DEN': { name: 'Denver Broncos', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/den.png' }, 'NFL-DET': { name: 'Detroit Lions', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/det.png' }, 'NFL-GB': { name: 'Green Bay Packers', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/gb.png' }, 'NFL-HOU': { name: 'Houston Texans', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/hou.png' }, 'NFL-IND': { name: 'Indianapolis Colts', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/ind.png' }, 'NFL-JAX': { name: 'Jacksonville Jaguars', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/jax.png' }, 'NFL-KC': { name: 'Kansas City Chiefs', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/kc.png' }, 'NFL-LV': { name: 'Las Vegas Raiders', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/lv.png' }, 'NFL-LAC': { name: 'Los Angeles Chargers', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/lac.png' }, 'NFL-LAR': { name: 'Los Angeles Rams', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/lar.png' }, 'NFL-MIA': { name: 'Miami Dolphins', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/mia.png' }, 'NFL-MIN': { name: 'Minnesota Vikings', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/min.png' }, 'NFL-NE': { name: 'New England Patriots', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/ne.png' }, 'NFL-NO': { name: 'New Orleans Saints', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/no.png' }, 'NFL-NYG': { name: 'New York Giants', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/nyg.png' }, 'NFL-NYJ': { name: 'New York Jets', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/nyj.png' }, 'NFL-PHI': { name: 'Philadelphia Eagles', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/phi.png' }, 'NFL-PIT': { name: 'Pittsburgh Steelers', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/pit.png' }, 'NFL-SF': { name: 'San Francisco 49ers', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/sf.png' }, 'NFL-SEA': { name: 'Seattle Seahawks', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/sea.png' }, 'NFL-TB': { name: 'Tampa Bay Buccaneers', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/tb.png' }, 'NFL-TEN': { name: 'Tennessee Titans', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/ten.png' }, 'NFL-WSH': { name: 'Washington Commanders', logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/wsh.png' }, 
'NCAAF-ALA': { name: 'Alabama Crimson Tide', logo: 'https://a.espncdn.com/i/teamlogos/ncaaf/500/333.png' }, 'NCAAF-CLE': { name: 'Clemson Tigers', logo: 'https://a.espncdn.com/i/teamlogos/ncaaf/500/228.png' }, 'NCAAF-OSU': { name: 'Ohio State Buckeyes', logo: 'https://a.espncdn.com/i/teamlogos/ncaaf/500/194.png' }, 'NCAAF-UGA': { name: 'Georgia Bulldogs', logo: 'https://a.espncdn.com/i/teamlogos/ncaaf/500/61.png' }, 'NCAAF-LSU': { name: 'LSU Tigers', logo: 'https://a.espncdn.com/i/teamlogos/ncaaf/500/99.png' }, 'NCAAF-OKL': { name: 'Oklahoma Sooners', logo: 'https://a.espncdn.com/i/teamlogos/ncaaf/500/201.png' }, 'NCAAF-TEX': { name: 'Texas Longhorns', logo: 'https://a.espncdn.com/i/teamlogos/ncaaf/500/251.png' }, 'NCAAF-USC': { name: 'USC Trojans', logo: 'https://a.espncdn.com/i/teamlogos/ncaaf/500/30.png' }, 'NCAAF-ND': { name: 'Notre Dame Fighting Irish', logo: 'https://a.espncdn.com/i/teamlogos/ncaaf/500/87.png' }, 'NCAAF-MIC': { name: 'Michigan Wolverines', logo: 'https://a.espncdn.com/i/teamlogos/ncaaf/500/130.png' },
'NCAAB-DUK': { name: 'Duke Blue Devils', logo: 'https://a.espncdn.com/i/teamlogos/ncaab/500/150.png' }, 'NCAAB-UNC': { name: 'North Carolina Tar Heels', logo: 'https://a.espncdn.com/i/teamlogos/ncaab/500/153.png' }, 'NCAAB-KEN': { name: 'Kentucky Wildcats', logo: 'https://a.espncdn.com/i/teamlogos/ncaab/500/96.png' }, 'NCAAB-KAN': { name: 'Kansas Jayhawks', logo: 'https://a.espncdn.com/i/teamlogos/ncaab/500/2305.png' }, 'NCAAB-GON': { name: 'Gonzaga Bulldogs', logo: 'https://a.espncdn.com/i/teamlogos/ncaab/500/2250.png' }, 'NCAAB-VIL': { name: 'Villanova Wildcats', logo: 'https://a.espncdn.com/i/teamlogos/ncaab/500/222.png' }, 'NCAAB-BAY': { name: 'Baylor Bears', logo: 'https://a.espncdn.com/i/teamlogos/ncaab/500/239.png' }, 'NCAAB-UCL': { name: 'UCLA Bruins', logo: 'https://a.espncdn.com/i/teamlogos/ncaab/500/26.png' }, 'NCAAB-HOU': { name: 'Houston Cougars', logo: 'https://a.espncdn.com/i/teamlogos/ncaab/500/2287.png' }, 'NCAAB-PUR': { name: 'Purdue Boilermakers', logo: 'https://a.espncdn.com/i/teamlogos/ncaab/500/2509.png' },
'NBA-BOS': { name: 'Boston Celtics', logo: 'https://a.espncdn.com/i/teamlogos/nba/500/bos.png' },'NBA-BKN': { name: 'Brooklyn Nets', logo: 'https://a.espncdn.com/i/teamlogos/nba/500/bkn.png' },'NBA-NYK': { name: 'New York Knicks', logo: 'https://a.espncdn.com/i/teamlogos/nba/500/nyk.png' },'NBA-PHI': { name: 'Philadelphia 76ers', logo: 'https://a.espncdn.com/i/teamlogos/nba/500/phi.png' },'NBA-TOR': { name: 'Toronto Raptors', logo: 'https://a.espncdn.com/i/teamlogos/nba/500/tor.png' },'NBA-CHI': { name: 'Chicago Bulls', logo: 'https://a.espncdn.com/i/teamlogos/nba/500/chi.png' },'NBA-CLE': { name: 'Cleveland Cavaliers', logo: 'https://a.espncdn.com/i/teamlogos/nba/500/cle.png' }, 'SOCCER-LIV': { name: 'Liverpool', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/364.png' },'SOCCER-MCFC': { name: 'Manchester City', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/382.png' },'SOCCER-ARS': { name: 'Arsenal', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/359.png' },'NHL-ANA':{name:'Anaheim Ducks',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/ana.png'},'NHL-ARI':{name:'Arizona Coyotes',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/ari.png'},'NHL-BOS':{name:'Boston Bruins',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/bos.png'},'NHL-BUF':{name:'Buffalo Sabres',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/buf.png'},'NHL-CGY':{name:'Calgary Flames',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/cgy.png'},'NHL-CAR':{name:'Carolina Hurricanes',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/car.png'},'NHL-CHI':{name:'Chicago Blackhawks',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/chi.png'},'NHL-COL':{name:'Colorado Avalanche',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/col.png'},'NHL-CBJ':{name:'Columbus Blue Jackets',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/cbj.png'},'NHL-DAL':{name:'Dallas Stars',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/dal.png'},'NHL-DET':{name:'Detroit Red Wings',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/det.png'},'NHL-EDM':{name:'Edmonton Oilers',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/edm.png'},'NHL-FLA':{name:'Florida Panthers',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/fla.png'},'NHL-LAK':{name:'Los Angeles Kings',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/lak.png'},'NHL-MIN':{name:'Minnesota Wild',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/min.png'},'NHL-MTL':{name:'Montreal Canadiens',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/mtl.png'},'NHL-NSH':{name:'Nashville Predators',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/nsh.png'},'NHL-NJD':{name:'New Jersey Devils',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/njd.png'},'NHL-NYI':{name:'New York Islanders',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/nyi.png'},'NHL-NYR':{name:'New York Rangers',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/nyr.png'},'NHL-OTT':{name:'Ottawa Senators',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/ott.png'},'NHL-PHI':{name:'Philadelphia Flyers',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/phi.png'},'NHL-PIT':{name:'Pittsburgh Penguins',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/pit.png'},'NHL-SJS':{name:'San Jose Sharks',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/sjs.png'},'NHL-SEA':{name:'Seattle Kraken',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/sea.png'},'NHL-STL':{name:'St. Louis Blues',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/stl.png'},'NHL-TBL':{name:'Tampa Bay Lightning',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/tb.png'},'NHL-TOR':{name:'Toronto Maple Leafs',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/tor.png'},'NHL-VAN':{name:'Vancouver Canucks',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/van.png'},'NHL-VGK':{name:'Vegas Golden Knights',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/vgk.png'},'NHL-WSH':{name:'Washington Capitals',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/wsh.png'},'NHL-WPG':{name:'Winnipeg Jets',logo:'https://a.espncdn.com/i/teamlogos/nhl/500/wpg.png'},'WNBA-ATL':{name:'Atlanta Dream',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/atl.png'},'WNBA-CHI':{name:'Chicago Sky',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/chi.png'},'WNBA-CON':{name:'Connecticut Sun',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/conn.png'},'WNBA-DAL':{name:'Dallas Wings',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/dal.png'},'WNBA-IND':{name:'Indiana Fever',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/ind.png'},'WNBA-LV':{name:'Las Vegas Aces',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/lv.png'},'WNBA-LA':{name:'Los Angeles Sparks',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/la.png'},'WNBA-MIN':{name:'Minnesota Lynx',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/min.png'},'WNBA-NY':{name:'New York Liberty',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/ny.png'},'WNBA-PHO':{name:'Phoenix Mercury',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/phx.png'},'WNBA-SEA':{name:'Seattle Storm',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/sea.png'},'WNBA-WSH':{name:'Washington Mystics',logo:'https://a.espncdn.com/i/teamlogos/wnba/500/wsh.png'},'SOCCER-MUN': { name: 'Manchester United', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/360.png' }, 'SOCCER-CHE': { name: 'Chelsea', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/363.png' }, 'SOCCER-JUV': { name: 'Juventus', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/111.png' }, 'SOCCER-INT': { name: 'Inter Milan', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/110.png' }, 'SOCCER-ACM': { name: 'AC Milan', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/103.png' }, 'SOCCER-ROM': { name: 'AS Roma', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/114.png' }, 'SOCCER-RMA': { name: 'Real Madrid', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/86.png' }, 'SOCCER-BAR': { name: 'Barcelona', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/83.png' }, 'SOCCER-ATM': { name: 'Atlético Madrid', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/1068.png' }, 'SOCCER-SEV': { name: 'Sevilla', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/91.png' }, 'SOCCER-BAY': { name: 'Bayern Munich', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/132.png' }, 'SOCCER-BVB': { name: 'Borussia Dortmund', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/124.png' }, 'SOCCER-RBL': { name: 'RB Leipzig', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/9618.png' }, 'SOCCER-B04': { name: 'Bayer Leverkusen', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/131.png' }, 'SOCCER-PSG': { name: 'Paris Saint-Germain', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/160.png' }, 'SOCCER-MAR': { name: 'Marseille', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/176.png' }, 'SOCCER-LYO': { name: 'Lyon', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/162.png' }, 'SOCCER-MON': { name: 'AS Monaco', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/174.png' }, 'SOCCER-AJA': { name: 'Ajax', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/140.png' }, 'SOCCER-PSV': { name: 'PSV Eindhoven', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/144.png' }, 'SOCCER-FEY': { name: 'Feyenoord', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/142.png' }, 'SOCCER-BEN': { name: 'Benfica', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/190.png' }, 'SOCCER-POR': { name: 'FC Porto', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/191.png' }, 'SOCCER-BRU': { name: 'Club Brugge', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/198.png' }, 'SOCCER-AND': { name: 'Anderlecht', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/197.png' }, 'SOCCER-GAL': { name: 'Galatasaray', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/346.png' }, 'SOCCER-FEN': { name: 'Fenerbahçe', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/347.png' }, 'SOCCER-SLP': { name: 'Slavia Prague', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/1715.png' }, 'SOCCER-SPP': { name: 'Sparta Prague', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/1714.png' }, 'SOCCER-CEL': { name: 'Celtic', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/238.png' }, 'SOCCER-RAN': { name: 'Rangers', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/237.png' }, 'SOCCER-YBO': { name: 'Young Boys', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/609.png' }, 'SOCCER-BAS': { name: 'FC Basel', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/608.png' }, 'SOCCER-SAL': { name: 'Red Bull Salzburg', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/284.png' }, 
'SOCCER-STU': { name: 'Sturm Graz', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/296.png' }, 'SOCCER-BOD': { name: 'FK Bodø/Glimt', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/4144.png' }, 'SOCCER-MOL': { name: 'Molde FK', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/314.png' }, 'SOCCER-OLY': { name: 'Olympiacos', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/259.png' }, 'SOCCER-PAO': { name: 'PAOK FC', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/262.png' }, 'SOCCER-CRE': { name: 'Cremonese', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/104.png' }, 'SOCCER-VER': { name: 'Hellas Verona', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/109.png' }, 'SOCCER-GEN': { name: 'Genoa', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/108.png' }, 'SOCCER-COM': { name: 'Como', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/3858.png' }, 'SOCCER-MAL': { name: 'Mallorca', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/92.png' }, 'SOCCER-ESP': { name: 'Espanyol', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/88.png' },
'SOCCER-TOT': { name: 'Tottenham Hotspur', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/367.png' }, 'SOCCER-VIL': { name: 'Villarreal', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/94.png' }, 'SOCCER-ATB': { name: 'Athletic Bilbao', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/81.png' }, 'SOCCER-USG': { name: 'Union Saint-Gilloise', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/4513.png' }, 'SOCCER-QAR': { name: 'FK Qarabag', logo: 'https://a.espncdn.com/i/teamlogos/soccer/500/4301.png' }
};
            const TEAM_ALIAS_TO_CODE = { 'boston red sox': 'BOS', 'bos red sox': 'BOS', 'red sox': 'BOS', 'chicago cubs': 'CHC', 'chi cubs': 'CHC', 'cubs': 'CHC', 'chicago white sox': 'CWS', 'chi white sox': 'CWS', 'white sox': 'CWS', 'pittsburgh pirates': 'PIT', 'pit pirates': 'PIT', 'pirates': 'PIT', 'san diego padres': 'SD', 'sd padres': 'SD', 'padres': 'SD', 'washington nationals': 'WSH', 'was nationals': 'WSH', 'nationals': 'WSH', 'los angeles angels': 'LAA', 'la angels': 'LAA', 'angels': 'LAA', 'philadelphia phillies': 'PHI', 'phi phillies': 'PHI', 'phillies': 'PHI', 'san francisco giants': 'SF', 'sf giants': 'SF', 'giants': 'SF', 'toronto blue jays': 'TOR', 'tor blue jays': 'TOR', 'blue jays': 'TOR', 'new york yankees': 'NYY', 'ny yankees': 'NYY', 'yankees': 'NYY', 'atlanta braves': 'ATL', 'atl braves': 'ATL', 'braves': 'ATL', 'milwaukee brewers': 'MIL', 'mil brewers': 'MIL', 'brewers': 'MIL', 'los angeles dodgers': 'LAD', 'la dodgers': 'LAD', 'dodgers': 'LAD', 'houston astros': 'HOU', 'hou astros': 'HOU', 'astros': 'HOU', 'seattle mariners': 'SEA', 'sea mariners': 'SEA', 'mariners': 'SEA', 'cincinnati reds': 'CIN', 'cin reds': 'CIN', 'reds': 'CIN', 'st louis cardinals': 'STL', 'stl cardinals': 'STL', 'cardinals': 'STL', 'tampa bay rays': 'TB', 'tb rays': 'TB', 'rays': 'TB', 'baltimore orioles': 'BAL', 'bal orioles': 'BAL', 'orioles': 'BAL', 'cleveland guardians': 'CLE', 'cle guardians': 'CLE', 'guardians': 'CLE', 'minnesota twins': 'MIN', 'min twins': 'MIN', 'twins': 'MIN', 'kansas city royals': 'KC', 'kc royals': 'KC', 'royals': 'KC', 'detroit tigers': 'DET', 'det tigers': 'DET', 'tigers': 'DET', 'texas rangers': 'TEX', 'tex rangers': 'TEX', 'rangers': 'TEX', 'oakland athletics': 'OAK', 'oak athletics': 'OAK', 'athletics': 'OAK', 'new york mets': 'NYM', 'ny mets': 'NYM', 'mets': 'NYM', 'miami marlins': 'MIA', 'mia marlins': 'MIA', 'marlins': 'MIA', 'arizona diamondbacks': 'ARI', 'ari diamondbacks': 'ARI', 'd-backs': 'ARI', 'diamondbacks': 'ARI', 'colorado rockies': 'COL', 'col rockies': 'COL', 'rockies': 'COL', 'hamilton tiger-cats': 'CFL-HAM', 'tiger-cats': 'CFL-HAM', 'ticats': 'CFL-HAM', 'calgary stampeders': 'CFL-CGY', 'stampeders': 'CFL-CGY', 'toronto argonauts': 'CFL-TOR', 'argonauts': 'CFL-TOR', 'argos': 'CFL-TOR', 'saskatchewan roughriders': 'CFL-SSK', 'roughriders': 'CFL-SSK', 'riders': 'CFL-SSK', 'bc lions': 'CFL-BC', 'lions': 'CFL-BC', 'edmonton elks': 'CFL-EDM', 'elks': 'CFL-EDM', 'winnipeg blue bombers': 'CFL-WPG', 'blue bombers': 'CFL-WPG', 'bombers': 'CFL-WPG', 'montreal alouettes': 'CFL-MTL', 'alouettes': 'CFL-MTL', 'als': 'CFL-MTL', 'ottawa redblacks': 'CFL-OTT', 'redblacks': 'CFL-OTT', 'arizona cardinals': 'NFL-ARI', 'atlanta falcons': 'NFL-ATL', 'baltimore ravens': 'NFL-BAL', 'ravens': 'NFL-BAL', 'buffalo bills': 'NFL-BUF', 'bills': 'NFL-BUF', 'carolina panthers': 'NFL-CAR', 'panthers': 'NFL-CAR', 'chicago bears': 'NFL-CHI', 'bears': 'NFL-CHI', 'cincinnati bengals': 'NFL-CIN', 'bengals': 'NFL-CIN', 'cleveland browns': 'NFL-CLE', 'browns': 'NFL-CLE', 'dallas cowboys': 'NFL-DAL', 'cowboys': 'NFL-DAL', 'denver broncos': 'NFL-DEN', 'broncos': 'NFL-DEN', 'detroit lions': 'NFL-DET', 'green bay packers': 'NFL-GB', 'packers': 'NFL-GB', 'green bay': 'NFL-GB', 'houston texans': 'NFL-HOU', 'texans': 'NFL-HOU', 'indianapolis colts': 'NFL-IND', 'colts': 'NFL-IND', 'jacksonville jaguars': 'NFL-JAX', 'jaguars': 'NFL-JAX', 'kansas city chiefs': 'NFL-KC', 'chiefs': 'NFL-KC', 'las vegas raiders': 'NFL-LV', 'raiders': 'NFL-LV', 'los angeles chargers': 'NFL-LAC', 'chargers': 'NFL-LAC', 'los angeles rams': 'NFL-LAR', 'rams': 'NFL-LAR', 'miami dolphins': 'NFL-MIA', 'dolphins': 'NFL-MIA', 'minnesota vikings': 'NFL-MIN', 'vikings': 'NFL-MIN', 'new england patriots': 'NFL-NE', 'patriots': 'NFL-NE', 'new orleans saints': 'NFL-NO', 'saints': 'NFL-NO', 'new york giants': 'NFL-NYG', 'new york jets': 'NFL-NYJ', 'philadelphia eagles': 'NFL-PHI', 'eagles': 'NFL-PHI', 'pittsburgh steelers': 'NFL-PIT', 'steelers': 'NFL-PIT', 'san francisco 49ers': 'NFL-SF', '49ers': 'NFL-SF', 'niners': 'NFL-SF', 'seattle seahawks': 'NFL-SEA', 'seahawks': 'NFL-SEA', 'tampa bay buccaneers': 'NFL-TB', 'buccaneers': 'NFL-TB', 'bucs': 'NFL-TB', 'tennessee titans': 'NFL-TEN', 'titans': 'NFL-TEN', 'washington commanders': 'NFL-WSH', 'commanders': 'NFL-WSH', 'alabama crimson tide': 'NCAAF-ALA', 'clemson tigers': 'NCAAF-CLE', 'ohio state buckeyes': 'NCAAF-OSU', 'georgia bulldogs': 'NCAAF-UGA', 'lsu tigers': 'NCAAF-LSU', 'oklahoma sooners': 'NCAAF-OKL', 'texas longhorns': 'NCAAF-TEX', 'usc trojans': 'NCAAF-USC', 'notre dame fighting irish': 'NCAAF-ND', 'michigan wolverines': 'NCAAF-MIC', 'duke blue devils': 'NCAAB-DUK', 'north carolina tar heels': 'NCAAB-UNC', 'kentucky wildcats': 'NCAAB-KEN', 'kansas jayhawks': 'NCAAB-KAN', 'gonzaga bulldogs': 'NCAAB-GON', 'villanova wildcats': 'NCAAB-VIL', 'baylor bears': 'NCAAB-BAY', 'ucla bruins': 'NCAAB-UCL', 'houston cougars': 'NCAAB-HOU', 'purdue boilermakers': 'NCAAB-PUR', 'boston celtics': 'NBA-BOS', 'celtics': 'NBA-BOS', 'brooklyn nets': 'NBA-BKN', 'nets': 'NBA-BKN', 'new york knicks': 'NBA-NYK', 'knicks': 'NBA-NYK', 'philadelphia 76ers': 'NBA-PHI', '76ers': 'NBA-PHI', 'toronto raptors': 'NBA-TOR', 'raptors': 'NBA-TOR', 'chicago bulls': 'NBA-CHI', 'bulls': 'NBA-CHI', 'cleveland cavaliers': 'NBA-CLE', 'cavaliers': 'NBA-CLE', 'liverpool': 'SOCCER-LIV', 'manchester city': 'SOCCER-MCFC', 'man city': 'SOCCER-MCFC', 'arsenal': 'SOCCER-ARS','anaheim ducks':'NHL-ANA','arizona coyotes':'NHL-ARI','boston bruins':'NHL-BOS','bruins':'NHL-BOS','buffalo sabres':'NHL-BUF','sabres':'NHL-BUF','calgary flames':'NHL-CGY','flames':'NHL-CGY','carolina hurricanes':'NHL-CAR','hurricanes':'NHL-CAR','chicago blackhawks':'NHL-CHI','blackhawks':'NHL-CHI','colorado avalanche':'NHL-COL','avalanche':'NHL-COL','columbus blue jackets':'NHL-CBJ','blue jackets':'NHL-CBJ','dallas stars':'NHL-DAL','stars':'NHL-DAL','detroit red wings':'NHL-DET','red wings':'NHL-DET','edmonton oilers':'NHL-EDM','oilers':'NHL-EDM','florida panthers':'NHL-FLA','la kings':'NHL-LAK','los angeles kings':'NHL-LAK','minnesota wild':'NHL-MIN','wild':'NHL-MIN','montreal canadiens':'NHL-MTL','canadiens':'NHL-MTL','nashville predators':'NHL-NSH','predators':'NHL-NSH','new jersey devils':'NHL-NJD','devils':'NHL-NJD','new york islanders':'NHL-NYI','islanders':'NHL-NYI','new york rangers':'NHL-NYR','san jose sharks':'NHL-SJS','sharks':'NHL-SJS','seattle kraken':'NHL-SEA','kraken':'NHL-SEA','st louis blues':'NHL-STL','blues':'NHL-STL','tampa bay lightning':'NHL-TBL','lightning':'NHL-TBL','toronto maple leafs':'NHL-TOR','maple leafs':'NHL-TOR','vancouver canucks':'NHL-VAN','canucks':'NHL-VAN','vegas golden knights':'NHL-VGK','golden knights':'NHL-VGK','washington capitals':'NHL-WSH','capitals':'NHL-WSH','winnipeg jets':'NHL-WPG','jets':'NHL-WPG', 'atlanta dream': 'WNBA-ATL', 'dream': 'WNBA-ATL', 'chicago sky': 'WNBA-CHI', 'sky': 'WNBA-CHI', 'connecticut sun': 'WNBA-CON', 'sun': 'WNBA-CON', 'dallas wings': 'WNBA-DAL', 'wings': 'WNBA-DAL', 'indiana fever': 'WNBA-IND', 'fever': 'WNBA-IND', 'las vegas aces': 'WNBA-LV', 'aces': 'WNBA-LV', 'los angeles sparks': 'WNBA-LA', 'sparks': 'WNBA-LA', 'minnesota lynx': 'WNBA-MIN', 'lynx': 'WNBA-MIN', 'new york liberty': 'WNBA-NY', 'liberty': 'WNBA-NY', 'phoenix mercury': 'WNBA-PHO', 'mercury': 'WNBA-PHO', 'seattle storm': 'WNBA-SEA', 'storm': 'WNBA-SEA', 'washington mystics': 'WNBA-WSH', 'mystics': 'WNBA-WSH', 'manchester united': 'SOCCER-MUN', 'man united': 'SOCCER-MUN', 'manchester united fc': 'SOCCER-MUN', 'chelsea': 'SOCCER-CHE', 'chelsea fc': 'SOCCER-CHE', 'liverpool fc': 'SOCCER-LIV', 'manchester city fc': 'SOCCER-MCFC', 'arsenal fc': 'SOCCER-ARS', 'juventus': 'SOCCER-JUV', 'juventus fc': 'SOCCER-JUV', 'inter milan': 'SOCCER-INT', 'inter': 'SOCCER-INT', 'internazionale': 'SOCCER-INT', 'fc internazionale milano': 'SOCCER-INT', 'ac milan': 'SOCCER-ACM', 'as roma': 'SOCCER-ROM', 'roma': 'SOCCER-ROM', 'real madrid': 'SOCCER-RMA', 'real madrid cf': 'SOCCER-RMA', 'barcelona': 'SOCCER-BAR', 'fc barcelona': 'SOCCER-BAR', 'atlético madrid': 'SOCCER-ATM', 'atletico madrid': 'SOCCER-ATM', 'atletico de madrid': 'SOCCER-ATM', 'sevilla': 'SOCCER-SEV', 'sevilla fc': 'SOCCER-SEV', 'bayern munich': 'SOCCER-BAY', 'bayern': 'SOCCER-BAY', 'fc bayern munich': 'SOCCER-BAY', 'borussia dortmund': 'SOCCER-BVB', 'dortmund': 'SOCCER-BVB', 'rb leipzig': 'SOCCER-RBL', 'leipzig': 'SOCCER-RBL', 'bayer leverkusen': 'SOCCER-B04', 'leverkusen': 'SOCCER-B04', 'bayer 04 leverkusen': 'SOCCER-B04', 'paris saint-germain': 'SOCCER-PSG', 'psg': 'SOCCER-PSG', 'paris saint germain fc': 'SOCCER-PSG', 'marseille': 'SOCCER-MAR', 'olympique de marseille': 'SOCCER-MAR', 'lyon': 'SOCCER-LYO', 'olympique lyonnais': 'SOCCER-LYO', 'as monaco': 'SOCCER-MON', 'monaco': 'SOCCER-MON', 'as monaco fc': 'SOCCER-MON', 'ajax': 'SOCCER-AJA', 'afc ajax': 'SOCCER-AJA', 'psv eindhoven': 'SOCCER-PSV', 'psv': 'SOCCER-PSV', 'feyenoord': 'SOCCER-FEY', 'benfica': 'SOCCER-BEN', 'sl benfica': 'SOCCER-BEN', 'fc porto': 'SOCCER-POR', 'porto': 'SOCCER-POR', 'club brugge': 'SOCCER-BRU', 'club brugge kv': 'SOCCER-BRU', 'anderlecht': 'SOCCER-AND', 'rsc anderlecht': 'SOCCER-AND', 'galatasaray': 'SOCCER-GAL', 'galatasaray sk': 'SOCCER-GAL', 'fenerbahçe': 'SOCCER-FEN', 'fenerbahce': 'SOCCER-FEN', 'fenerbahce sk': 'SOCCER-FEN', 'slavia prague': 'SOCCER-SLP', 'sk slavia prague': 'SOCCER-SLP', 'sparta prague': 'SOCCER-SPP', 'ac sparta prague': 'SOCCER-SPP', 'celtic': 'SOCCER-CEL', 'celtic fc': 'SOCCER-CEL', 'rangers': 'SOCCER-RAN', 'rangers fc': 'SOCCER-RAN', 'young boys': 'SOCCER-YBO', 'bsc young boys': 'SOCCER-YBO', 'fc basel': 'SOCCER-BAS', 'fc basel 1893': 'SOCCER-BAS', 'red bull salzburg': 'SOCCER-SAL', 'rb salzburg': 'SOCCER-SAL', 'fc red bull salzburg': 'SOCCER-SAL', 'sturm graz': 'SOCCER-STU', 'sk sturm graz': 'SOCCER-STU', 'fk bodø/glimt': 'SOCCER-BOD', 'bodo glimt': 'SOCCER-BOD', 'fk bodo/glimt': 'SOCCER-BOD', 'molde fk': 'SOCCER-MOL', 'olympiacos': 'SOCCER-OLY', 'olympiacos fc': 'SOCCER-OLY', 'paok fc': 'SOCCER-PAO', 'cremonese': 'SOCCER-CRE', 'us cremonese': 'SOCCER-CRE', 'hellas verona': 'SOCCER-VER', 'hellas verona fc': 'SOCCER-VER', 'genoa': 'SOCCER-GEN', 'genoa cfc': 'SOCCER-GEN', 'como': 'SOCCER-COM', 'como 1907': 'SOCCER-COM', 'mallorca': 'SOCCER-MAL', 'rcd mallorca': 'SOCCER-MAL', 'espanyol': 'SOCCER-ESP', 'rcd espanyol': 'SOCCER-ESP', 'tottenham hotspur': 'SOCCER-TOT', 'tottenham': 'SOCCER-TOT', 'spurs': 'SOCCER-TOT', 'villarreal': 'SOCCER-VIL', 'villarreal cf': 'SOCCER-VIL', 'athletic bilbao': 'SOCCER-ATB', 'union saint gilloise': 'SOCCER-USG', 'union sg': 'SOCCER-USG', 'fk qarabag': 'SOCCER-QAR', 'qarabag': 'SOCCER-QAR' };
            const SPORT_MAP = { 'NFL': 'Football', 'CFL': 'Football', 'NCAAF': 'Football', 'MLB': 'Baseball', 'NBA': 'Basketball', 'WNBA': 'Basketball', 'SOCCER': 'Soccer', 'NHL': 'Hockey', 'NCAAB': 'Basketball' };

            function getTeamCode(name) {
                if (!name) return null;
                const cleanedName = name.toLowerCase().replace(/[.'-]/g, '').replace(/&/g, 'and').trim();
                return TEAM_ALIAS_TO_CODE[cleanedName] || null;
            }

            function getTeamInfo(messyName) {
                const teamCode = getTeamCode(messyName);
                const fallbackData = { name: messyName || 'Unknown', logo: `https://placehold.co/96x96/e2e8f0/64748b?text=${(messyName || '?').substring(0,2)}` };
                return teamCode ? TEAMS_DATA[teamCode] : fallbackData;
            }

            function getGameSport(game) {
                 if (game.sport && game.sport.toUpperCase() in SPORT_MAP) { return SPORT_MAP[game.sport.toUpperCase()]; }
                const awayCode = getTeamCode(game.away_team);
                if (awayCode && awayCode.includes('-')) { const prefix = awayCode.split('-')[0].toUpperCase(); if (prefix in SPORT_MAP) return SPORT_MAP[prefix]; }
                const homeCode = getTeamCode(game.home_team);
                if (homeCode && homeCode.includes('-')) { const prefix = homeCode.split('-')[0].toUpperCase(); if (prefix in SPORT_MAP) return SPORT_MAP[prefix]; }
                return 'Unknown';
            }

            // --- CORE LOGIC & CALCULATIONS ---
            const calculateEV = (winProb, decimalOdds) => (winProb * (decimalOdds - 1)) - (1 - winProb);
            
            const factorialCache = [1];
            function factorial(n) {
                if (n < 0) return NaN;
                if (n >= factorialCache.length) {
                    for (let i = factorialCache.length; i <= n; i++) {
                        factorialCache[i] = factorialCache[i - 1] * i;
                    }
                }
                return factorialCache[n];
            }

            function combinations(n, k) {
                if (k < 0 || k > n) {
                    return 0;
                }
                if (n - k < k) {
                    k = n - k;
                }
                let res = 1;
                for (let i = 1; i <= k; i++) {
                    res = res * (n - i + 1) / i;
                }
                return Math.round(res);
            }
            
            async function fetchAndAnalyzeGames() {
                if (!oddsApiKey) {
                    showError("The Odds API key is missing. Please add it to the code.");
                    return;
                }

                analyzeSection.classList.add('hidden');
                processingState.classList.remove('hidden');
                errorState.classList.add('hidden');
                gameListContainer.innerHTML = '';
                resultsArea.classList.add('hidden');

                try {
                    // Step 1: Fetch all active sports
                    processingText.textContent = 'Finding in-season sports...';
                    const sportsApiUrl = `https://api.the-odds-api.com/v4/sports/?apiKey=${oddsApiKey}`;
                    const sportsResponse = await fetch(sportsApiUrl);
                    if (!sportsResponse.ok) {
                        const errorData = await sportsResponse.json().catch(() => ({ message: sportsResponse.statusText }));
                        throw new Error(`Failed to fetch sports list: ${errorData.message}`);
                    }
                    const availableSports = await sportsResponse.json();

                    // Step 2: Filter for the sports we care about by their TITLES for robustness
                    const desiredSportTitles = [
                        'NFL', 'MLB', 'NBA', 'NHL', 'WNBA', 'CFL', 'NCAAF', 'NCAAB', // North American
                        'UEFA Champions League', 'Premier League', // Major Soccer
                        'Serie A', 'La Liga', 'Bundesliga', 'Ligue 1', // Top 5 Euro Soccer
                        'Eredivisie', 'Primeira Liga', 'Jupiler Pro League', 'Süper Lig', 
                        'Czech First League', 'Scottish Premiership', 'Swiss Super League', 
                        'Austrian Bundesliga', 'Eliteserien', 'Super League Greece'
                    ];

                    const activeSportsToFetch = availableSports
                        .filter(sport => desiredSportTitles.includes(sport.title) && sport.active)
                        .map(sport => sport.key);

                    if (activeSportsToFetch.length === 0) {
                        showError("No games for the selected sports are currently in-season or available from the API. Please check back later.");
                        processingState.classList.add('hidden');
                        analyzeSection.classList.remove('hidden');
                        return;
                    }

                    // Step 3: Fetch odds for the active sports
                    processingText.textContent = `Fetching odds for ${activeSportsToFetch.length} active sport(s)...`;
                    const regions = 'us';
                    const markets = 'h2h,spreads,totals';
                    const oddsFormat = 'decimal';

                    // Set the time window from now to the next 24 hours
                    const now = new Date();
                    const futureDate = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                    // Format the dates to YYYY-MM-DDTHH:mm:ssZ to match API docs precisely
                    const commenceTimeFrom = now.toISOString().slice(0, 19) + 'Z';
                    const commenceTimeTo = futureDate.toISOString().slice(0, 19) + 'Z';

                    const promises = activeSportsToFetch.map(sportKey => {
                        const apiUrl = `https://api.the-odds-api.com/v4/sports/${sportKey}/odds?apiKey=${oddsApiKey}&regions=${regions}&markets=${markets}&oddsFormat=${oddsFormat}&commenceTimeFrom=${commenceTimeFrom}&commenceTimeTo=${commenceTimeTo}`;
                        return fetch(apiUrl);
                    });

                    const responses = await Promise.all(promises);

                    let allGames = [];
                    for (const response of responses) {
                        if (!response.ok) {
                             // Try to get a more detailed error message from the API response body
                            const errorData = await response.json().catch(() => ({ message: response.statusText }));
                            console.warn(`Failed to fetch odds for one sport (${response.url}): ${response.status} ${errorData.message || response.statusText}`);
                            continue;
                        }
                        const data = await response.json();
                        allGames.push(...data);
                    }
                    
                    if (allGames.length === 0) {
                        showError("No upcoming games found for the currently active sports.");
                        analyzeSection.classList.remove('hidden');
                        return;
                    }
                    
                    const transformedData = allGames.map(transformApiData).filter(g => g !== null);
                    
                    if (transformedData.length > 0) {
                        ALL_SPORTS_DATA = transformedData;
                        displayGames(ALL_SPORTS_DATA);
                    } else {
                        showError("Could not process the odds data. There might be no valid markets available for today's games.");
                        analyzeSection.classList.remove('hidden');
                    }

                } catch (err) {
                    console.error("Failed to fetch odds:", err);
                    showError(`An error occurred: ${err.message}. Please check your API key and network connection.`);
                    analyzeSection.classList.remove('hidden');
                } finally {
                    processingState.classList.add('hidden');
                }
            }

            
            function transformApiData(apiGame) {
                const bookmaker = apiGame.bookmakers?.[0];
                if (!bookmaker) return null; // Skip if no odds data

                const moneylineMarket = bookmaker.markets.find(m => m.key === 'h2h');
                const spreadMarket = bookmaker.markets.find(m => m.key === 'spreads');
                const totalMarket = bookmaker.markets.find(m => m.key === 'totals');

                const moneylineAwayOutcome = moneylineMarket?.outcomes.find(o => o.name === apiGame.away_team);
                const moneylineHomeOutcome = moneylineMarket?.outcomes.find(o => o.name === apiGame.home_team);

                const spreadAwayOutcome = spreadMarket?.outcomes.find(o => o.name === apiGame.away_team);
                const spreadHomeOutcome = spreadMarket?.outcomes.find(o => o.name === apiGame.home_team);

                const totalOverOutcome = totalMarket?.outcomes.find(o => o.name === 'Over');
                const totalUnderOutcome = totalMarket?.outcomes.find(o => o.name === 'Under');

                let sport = 'Unknown';
                if (apiGame.sport_key.includes('nfl')) sport = 'NFL';
                else if (apiGame.sport_key.includes('cfl')) sport = 'CFL';
                else if (apiGame.sport_key.includes('ncaaf')) sport = 'NCAAF';
                else if (apiGame.sport_key.includes('ncaab')) sport = 'NCAAB';
                else if (apiGame.sport_key.includes('mlb')) sport = 'MLB';
                else if (apiGame.sport_key.includes('nba')) sport = 'NBA';
                else if (apiGame.sport_key.includes('wnba')) sport = 'WNBA';
                else if (apiGame.sport_key.includes('soccer')) sport = 'SOCCER';
                else if (apiGame.sport_key.includes('nhl')) sport = 'NHL';


                return {
                    sport: sport,
                    away_team: apiGame.away_team,
                    home_team: apiGame.home_team,
                    away_player_info: null,
                    home_player_info: null,
                    moneyline_away: moneylineAwayOutcome?.price || null,
                    moneyline_home: moneylineHomeOutcome?.price || null,
                    spread_away: spreadAwayOutcome?.point || null,
                    spread_away_odds: spreadAwayOutcome?.price || null,
                    spread_home: spreadHomeOutcome?.point || null,
                    spread_home_odds: spreadHomeOutcome?.price || null,
                    total_over: totalOverOutcome?.point || null,
                    total_over_odds: totalOverOutcome?.price || null,
                    total_under: totalUnderOutcome?.point || null,
                    total_under_odds: totalUnderOutcome?.price || null,
                };
            }

            function createGameCard(game, index) {
                const gameId = `game-${index}`;
                const card = document.createElement('div');
                card.className = 'game-card';
                card.id = gameId;
                card.dataset.gameIndex = index;
                const gameSport = getGameSport(game);
                card.dataset.sport = gameSport;

                const awayTeamInfo = getTeamInfo(game.away_team);
                const homeTeamInfo = getTeamInfo(game.home_team);
                const awayAmericanOdds = game.moneyline_away ? (game.moneyline_away >= 2 ? (game.moneyline_away - 1) * 100 : -100 / (game.moneyline_away - 1)) : null;
                const homeAmericanOdds = game.moneyline_home ? (game.moneyline_home >= 2 ? (game.moneyline_home - 1) * 100 : -100 / (game.moneyline_home - 1)) : null;
                
                const impliedAway = game.moneyline_away ? 1 / game.moneyline_away : 0.5;
                const impliedHome = game.moneyline_home ? 1 / game.moneyline_home : 0.5;
                const totalImplied = impliedAway + impliedHome;
                const normalizedAwayProb = totalImplied > 0 ? impliedAway / totalImplied : 0.5;
                const initialSliderValue = Math.round(normalizedAwayProb * 1000);
                
                card.innerHTML = `
                    <div class="relative"><span class="absolute -top-6 -left-6 text-xs font-bold uppercase px-3 py-1 rounded-br-lg rounded-tl-xl" style="background-color: var(--accent-color-light); color: var(--accent-text-dark);">${gameSport}</span></div>
                    <div class="grid md:grid-cols-2 gap-x-6 gap-y-8 items-start pt-4">
                        <!-- Team Matchup -->
                        <div class="flex items-center justify-around text-center">
                            <div class="flex flex-col items-center space-y-1 w-2/5">
                                <img src="${awayTeamInfo.logo}" alt="${awayTeamInfo.name}" class="h-16 w-16 md:h-20 md:w-20 object-contain mb-1" onerror="this.src='https://placehold.co/96x96/e2e8f0/64748b?text=${awayTeamInfo.name.substring(0,1)}'; this.onerror=null;">
                                <span class="font-bold text-sm md:text-base leading-tight">${awayTeamInfo.name}</span>
                                <span class="text-xs text-secondary h-6">${game.away_player_info || ''}</span>
                                ${awayAmericanOdds ? `<span class="font-semibold text-lg" style="color: var(--accent-color);">${awayAmericanOdds > 0 ? '+' : ''}${awayAmericanOdds.toFixed(0)}</span>` : ''}
                            </div>
                            <div class="font-bold text-xl text-secondary pb-10">VS</div>
                            <div class="flex flex-col items-center space-y-1 w-2/5">
                                <img src="${homeTeamInfo.logo}" alt="${homeTeamInfo.name}" class="h-16 w-16 md:h-20 md:w-20 object-contain mb-1" onerror="this.src='https://placehold.co/96x96/e2e8f0/64748b?text=${homeTeamInfo.name.substring(0,1)}'; this.onerror=null;">
                                <span class="font-bold text-sm md:text-base leading-tight">${homeTeamInfo.name}</span>
                                <span class="text-xs text-secondary h-6">${game.home_player_info || ''}</span>
                                ${homeAmericanOdds ? `<span class="font-semibold text-lg" style="color: var(--accent-color);">${homeAmericanOdds > 0 ? '+' : ''}${homeAmericanOdds.toFixed(0)}</span>` : ''}
                            </div>
                        </div>
                        
                        <!-- Controls & Results -->
                        <div class="border-t-2 md:border-t-0 md:border-l-2 pt-6 md:pt-0 md:pl-6" style="border-color: var(--border-color);">
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-2 text-center">Your Estimated True Probability</label>
                                <div class="flex items-center justify-between text-center font-bold text-lg mb-2">
                                    <input type="number" step="0.1" min="0" max="100" id="${gameId}-away-prob-input" value="${(normalizedAwayProb * 100).toFixed(1)}" class="prob-input">
                                    <input type="number" step="0.1" min="0" max="100" id="${gameId}-home-prob-input" value="${((1 - normalizedAwayProb) * 100).toFixed(1)}" class="prob-input">
                                </div>
                                <div class="flex items-center space-x-2"><input type="range" min="0" max="1000" value="${initialSliderValue}" class="flex-1 prob-slider" data-game-index="${index}" data-initial-value="${initialSliderValue}"></div>
                            </div>
                            <div class="mt-4 flex justify-center items-center space-x-2">
                                <button class="utility-btn fifty-fifty-btn text-xs" data-game-index="${index}">50/50</button>
                                <button class="utility-btn reset-prob-btn text-xs" data-game-index="${index}">Reset</button>
                            </div>
                            <div id="${gameId}-results" class="mt-4 space-y-3"></div>
                        </div>
                    </div>
                     <!-- AI Analysis Section -->
                    <div class="mt-4 pt-4 border-t" style="border-color: var(--border-color);">
                        <button class="get-analysis-btn utility-btn text-sm w-full flex items-center justify-center" data-game-index="${index}" data-away-team="${game.away_team}" data-home-team="${game.home_team}" data-sport="${gameSport}">
                             ✨ Get AI Game Analysis
                        </button>
                        <div id="game-${index}-analysis-container" class="text-sm text-secondary mt-3 p-3 rounded-lg" style="background-color: var(--input-bg); display: none;">
                            <!-- AI analysis will be loaded here -->
                        </div>
                    </div>
                `;
                return card;
            }

            // --- UI & STATE MANAGEMENT ---
            function showError(message, isPartial = false) {
                errorState.innerHTML = message; // Use innerHTML to render links
                errorState.classList.remove('hidden');
                if (!isPartial) {
                    processingState.classList.add('hidden');
                    analyzeSection.classList.remove('hidden');
                }
            }
            
            function resetApp() {
                resultsArea.classList.add('hidden');
                analyzeSection.classList.remove('hidden');
                ALL_SPORTS_DATA = []; 
                gameCardElements = [];
                gameListContainer.innerHTML = '';
                errorState.classList.add('hidden');
                evFilterToggle.checked = false;
                sortSelect.value = 'default';
                betSlip = [];
                renderBetSlip();
            }
            
            function updateSummaryDashboard() {
                const totalGames = ALL_SPORTS_DATA.length;
                let positiveEvOpps = 0;
                let maxEv = 0;

                gameCardElements.forEach(card => {
                    if (card.dataset.positiveEv === 'true') {
                        positiveEvOpps++;
                    }
                    maxEv = Math.max(maxEv, parseFloat(card.dataset.maxEv) || 0);
                });
                
                const impliedOdds = maxEv > 0 ? (1 / (1-maxEv)) : 'N/A';
                const americanOdds = maxEv > 0 ? (impliedOdds >= 2 ? `+${((impliedOdds - 1) * 100).toFixed(0)}` : `${(-100 / (impliedOdds - 1)).toFixed(0)}`) : 'N/A';


                summaryDashboard.innerHTML = `
                    <div class="stat-card">
                        <div class="text-sm text-secondary">Total Games</div>
                        <div class="text-2xl font-bold">${totalGames}</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-sm text-secondary">+EV Opportunities</div>
                        <div class="text-2xl font-bold text-green-500">${positiveEvOpps}</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-sm text-secondary">Highest EV Found</div>
                        <div class="text-2xl font-bold text-green-500">${maxEv > 0 ? `+${(maxEv * 100).toFixed(2)}%` : '0%'}</div>
                    </div>
                     <div class="stat-card">
                        <div class="text-sm text-secondary">Implied Odds</div>
                        <div class="text-2xl font-bold">${americanOdds}</div>
                    </div>
                `;
            }
            
            function displayGames(games) {
                gameListContainer.innerHTML = '';
                gameCardElements = [];
                if (games && games.length > 0) {
                    games.forEach((game, index) => {
                        const card = createGameCard(game, index);
                        gameCardElements.push(card);
                        const slider = card.querySelector('.prob-slider');
                        const awayProb = parseFloat(slider.value) / 1000;
                        // Pass the card element directly here, as it's not in the DOM yet
                        calculateAndDisplayResults(card, index, awayProb);
                    });
                    resultsArea.classList.remove('hidden');
                    displayStrategyControls(games);
                    applyFiltersAndSorting();
                    attachEventListeners();
                    updateSummaryDashboard();
                } else {
                    showError("No valid games could be displayed from the API response.");
                    resultsArea.classList.add('hidden');
                }
            }
            
            function displayStrategyControls(games) {
                const sports = [...new Set(games.map(getGameSport))].filter(s => s !== 'Unknown').sort();
                strategyOptionsContainer.innerHTML = '';
                if (sports.length > 0) {
                    sports.forEach(sport => {
                        const controlEl = document.createElement('div');
                        controlEl.className = 'flex flex-col items-center';
                        controlEl.innerHTML = `
                            <label for="strategy-${sport}" class="text-sm font-medium mb-1">${sport}</label>
                            <select id="strategy-${sport}" data-sport="${sport}" class="strategy-select text-sm rounded-md p-1 w-full" style="background-color: var(--input-bg); border: 1px solid var(--border-color);">
                                <option value="take">Take Winner</option>
                                <option value="fade">Fade Winner</option>
                                <option value="ignore">Ignore</option>
                            </select>
                        `;
                        strategyOptionsContainer.appendChild(controlEl);
                        if(sport === 'Baseball' || sport === 'Soccer') {
                            controlEl.querySelector('select').value = 'fade';
                        }
                    });
                    strategyControls.classList.remove('hidden');
                    generateParlayBtn.disabled = false;
                } else {
                    strategyControls.classList.add('hidden');
                    generateParlayBtn.disabled = true;
                }
            }

            function calculateAndDisplayResults(card, gameIndex, awayProb) {
                const game = ALL_SPORTS_DATA[gameIndex];
                // This function now receives the card element directly to avoid DOM lookup issues on initial load
                if (!card || !game) return;
                const resultsContainer = card.querySelector(`#game-${gameIndex}-results`);
                resultsContainer.innerHTML = '';
                const homeProb = 1 - awayProb;
                
                let maxPositiveEv = 0;
                let hasPositiveEv = false;
                
                const createResultElement = (ev, label, odds) => {
                    if (!odds) return document.createDocumentFragment();
                    if (ev > 0) {
                        hasPositiveEv = true;
                        maxPositiveEv = Math.max(maxPositiveEv, ev);
                    }
                    const el = document.createElement('div');
                    el.className = `result-display items-center ${ev > 0 ? 'positive-ev' : 'negative-ev'}`;

                    const oddsText = odds >= 2 ? `+${((odds - 1) * 100).toFixed(0)}` : `${(-100 / (odds - 1)).toFixed(0)}`;
                    const evText = ev > 0 ? `+${(ev * 100).toFixed(2)}%` : `${(ev * 100).toFixed(2)}%`;

                    // Visual Edge Indicator Logic
                    const barWidth = Math.min(Math.abs(ev) * 100 * 4, 100); // Scaled by 4, so 25% EV is a full bar
                    let barColor;

                    if (ev > 0.10) { // > 10% EV
                        barColor = '#16a34a'; // a strong green
                    } else if (ev > 0.05) { // > 5% EV
                        barColor = '#22c55e'; // a medium green
                    } else if (ev > 0) { // > 0% EV
                        barColor = '#4ade80'; // a light green
                    } else { // Negative EV
                        barColor = '#ef4444'; // a standard red
                    }

                    el.innerHTML = `
                        <div class="flex-grow">
                            <strong>${label}</strong> 
                            <span class="text-xs text-secondary">${oddsText}</span>
                        </div>
                        <div class="flex items-center flex-shrink-0">
                            <span class="font-bold w-16 text-right">${evText}</span>
                            <div class="w-12 h-1.5 ml-2 rounded-full overflow-hidden" style="background-color: var(--input-bg);">
                                <div class="h-full rounded-full" style="width: ${barWidth}%; background-color: ${barColor};"></div>
                            </div>
                        </div>
                    `;
                    // Make the element interactive
                    el.classList.add('bet-option', 'cursor-pointer', 'transition-all', 'hover:ring-2', 'hover:ring-offset-2');
                    el.dataset.betLabel = label;
                    el.dataset.betOdds = odds;

                    return el;
                };

                // Moneyline
                if (game.moneyline_away && game.moneyline_home) {
                    const awayMLEV = calculateEV(awayProb, game.moneyline_away);
                    const homeMLEV = calculateEV(homeProb, game.moneyline_home);
                    resultsContainer.appendChild(createResultElement(awayMLEV, getTeamInfo(game.away_team).name, game.moneyline_away));
                    resultsContainer.appendChild(createResultElement(homeMLEV, getTeamInfo(game.home_team).name, game.moneyline_home));
                }

                // Spread
                if (game.spread_away_odds && game.spread_home_odds) {
                    const awaySpreadEV = calculateEV(awayProb, game.spread_away_odds);
                    const homeSpreadEV = calculateEV(homeProb, game.spread_home_odds);
                    resultsContainer.appendChild(createResultElement(awaySpreadEV, `${getTeamInfo(game.away_team).name} ${game.spread_away > 0 ? '+' : ''}${game.spread_away}`, game.spread_away_odds));
                    resultsContainer.appendChild(createResultElement(homeSpreadEV, `${getTeamInfo(game.home_team).name} ${game.spread_home > 0 ? '+' : ''}${game.spread_home}`, game.spread_home_odds));
                }

                // Total
                if (game.total_over_odds && game.total_under_odds) {
                    const overTotalEV = calculateEV(awayProb, game.total_over_odds);
                    const underTotalEV = calculateEV(homeProb, game.total_under_odds);
                    resultsContainer.appendChild(createResultElement(overTotalEV, `Over ${game.total_over}`, game.total_over_odds));
                    resultsContainer.appendChild(createResultElement(underTotalEV, `Under ${game.total_under}`, game.total_under_odds));
                }

                card.dataset.maxEv = maxPositiveEv;
                card.dataset.positiveEv = hasPositiveEv;
            }

            function applyFiltersAndSorting() {
                const showPositiveOnly = evFilterToggle.checked;
                const sortBy = sortSelect.value;
                let cardsToDisplay = [...gameCardElements];

                if (showPositiveOnly) {
                    cardsToDisplay = cardsToDisplay.filter(card => card.dataset.positiveEv === 'true');
                }

                if (sortBy === 'highest-ev') {
                    cardsToDisplay.sort((a, b) => parseFloat(b.dataset.maxEv) - parseFloat(a.dataset.maxEv));
                } else {
                    cardsToDisplay.sort((a, b) => parseInt(a.dataset.gameIndex) - parseInt(b.dataset.gameIndex));
                }
                
                gameListContainer.innerHTML = '';
                cardsToDisplay.forEach(card => gameListContainer.appendChild(card));
                
                const hasPositiveEvGames = gameCardElements.some(card => card.dataset.positiveEv === 'true');
                copyBtn.disabled = !hasPositiveEvGames;
                addBestEvBtn.disabled = !hasPositiveEvGames;
                updateSummaryDashboard();
            }

            // --- BET SLIP & COMBO LOGIC ---

            function renderBetSlip() {
                if(betSlip.length > 0) {
                    betSlipArea.classList.remove('hidden');
                    emptySlipMessage.classList.add('hidden');
                    betSlipControls.classList.remove('hidden');
                } else {
                    emptySlipMessage.classList.remove('hidden');
                    betSlipControls.classList.add('hidden');
                }
                
                betSlipList.innerHTML = '';
                betSlip.forEach(bet => {
                    const betEl = document.createElement('div');
                    betEl.className = 'p-2 text-xs rounded-lg flex items-center justify-between';
                    betEl.style.backgroundColor = 'var(--accent-color-light)';
                    const game = ALL_SPORTS_DATA[bet.gameIndex];
                    const matchup = `${getTeamInfo(game.away_team).name} @ ${getTeamInfo(game.home_team).name}`;
                    const oddsText = bet.odds >= 2 ? `+${((bet.odds - 1) * 100).toFixed(0)}` : `${(-100 / (bet.odds - 1)).toFixed(0)}`;

                    betEl.innerHTML = `
                        <div class="flex-grow pr-2">
                            <p class="font-bold truncate" style="color: var(--accent-text-dark);">${bet.label}</p>
                            <p class="text-secondary truncate">${matchup}</p>
                        </div>
                        <div class="flex-shrink-0 font-bold text-center w-12" style="color: var(--accent-text-dark);">${oddsText}</div>
                         <button data-bet-id="${bet.id}" class="remove-bet-btn p-1 ml-1 rounded-full hover:bg-red-200 dark:hover:bg-red-800 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    `;
                    betSlipList.appendChild(betEl);
                });
                comboAnalysisBtn.disabled = betSlip.length < 2;
            }

            function handleBetClick(target) {
                const gameCard = target.closest('.game-card');
                const gameIndex = gameCard.dataset.gameIndex;
                const { betLabel, betOdds } = target.dataset;
                const betId = `${gameIndex}-${betLabel}`;

                // Deselect any other bet from the same game
                const existingBetIndex = betSlip.findIndex(b => b.gameIndex === gameIndex);
                if (existingBetIndex > -1) {
                    const oldBet = betSlip[existingBetIndex];
                    // If it's not the same bet, deselect the old one
                    if(oldBet.id !== betId) {
                          const oldBetEl = gameCard.querySelector(`.bet-option[data-bet-label="${CSS.escape(oldBet.label)}"]`);
                          if(oldBetEl) oldBetEl.style.borderColor = 'transparent';
                    }
                    betSlip.splice(existingBetIndex, 1);
                }

                // If the clicked bet was the one already selected, we just remove it (done above)
                // Otherwise, add the new one
                const isAlreadySelected = target.style.borderColor !== 'transparent' && target.style.borderColor !== '';
                if (!isAlreadySelected) {
                     betSlip.push({ id: betId, gameIndex, label: betLabel, odds: parseFloat(betOdds) });
                     target.style.borderColor = 'var(--accent-color)';
                } else {
                     target.style.borderColor = 'transparent';
                }

                renderBetSlip();
            }

            function handleAddBestEVBets() {
                // 1. Clear existing slip
                betSlip = [];
                document.querySelectorAll('.bet-option').forEach(el => el.style.borderColor = 'transparent');

                // 2. Iterate through each game card
                gameCardElements.forEach(card => {
                    // Skip if there's no positive EV opportunity in this game
                    if (card.dataset.positiveEv !== 'true') return;

                    let bestBetElForGame = null;
                    let maxEvForGame = -Infinity;

                    // Find the best bet in this specific card by checking all its result displays
                    card.querySelectorAll('.result-display').forEach(betEl => {
                        const evText = betEl.querySelector('span.font-bold').textContent; // e.g., "+5.25%" or "-10.50%"
                        const currentEv = parseFloat(evText.replace('%', ''));

                        if (currentEv > maxEvForGame) {
                            maxEvForGame = currentEv;
                            bestBetElForGame = betEl;
                        }
                    });

                    // If a best positive bet was found, add it to the slip
                    if (bestBetElForGame && maxEvForGame > 0) {
                        const gameIndex = card.dataset.gameIndex;
                        const { betLabel, betOdds } = bestBetElForGame.dataset;
                        const betId = `${gameIndex}-${betLabel}`;
                        
                        betSlip.push({ id: betId, gameIndex, label: betLabel, odds: parseFloat(betOdds) });
                        
                        // Visually select it on the card
                        bestBetElForGame.style.borderColor = 'var(--accent-color)';
                    }
                });

                // 3. Render the updated slip UI
                renderBetSlip();
            }

            function calculateAndDisplayComboAnalysis() {
                const numGames = betSlip.length;
                comboTotalGames.textContent = numGames;
                
                if (numGames < 2) {
                    comboAvgOdds.textContent = '0.00'
                    comboResultsContainer.innerHTML = `<p class="text-center text-secondary py-4">You need at least 2 bets in your slip to analyze round robins.</p>`;
                    return;
                }

                const wagerPerCombo = parseFloat(wagerPerComboInput.value) || 1;
                const totalOdds = betSlip.reduce((sum, bet) => sum + bet.odds, 0);
                const avgOdds = totalOdds / numGames;

                comboAvgOdds.textContent = avgOdds.toFixed(2);

                let resultsHtml = `
                    <table class="w-full text-sm text-left">
                        <thead class="sticky top-0 z-10" style="background-color: var(--container-bg);">
                            <tr class="border-b" style="border-color: var(--border-color);">
                                <th class="p-2 font-semibold">Combo Size</th>
                                <th class="p-2 font-semibold text-center">Total Cost</th>
                                <th class="p-2 font-semibold text-center">Wins for Profit</th>
                                <th class="p-2 font-semibold text-center">Profit at Break-Even</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                const maxComboSize = Math.min(10, numGames);

                for (let k = 2; k <= maxComboSize; k++) {
                    const numCombos = combinations(numGames, k);
                    const totalCost = numCombos * wagerPerCombo;
                    const payoutPerCombo = (avgOdds ** k) * wagerPerCombo;

                    let winsNeeded = -1;
                    let profitAtBreakEven = 0;

                    for (let w = k; w <= numGames; w++) {
                        const winningCombos = combinations(w, k);
                        const totalWinnings = winningCombos * payoutPerCombo;
                        if (totalWinnings > totalCost) {
                            winsNeeded = w;
                            profitAtBreakEven = totalWinnings - totalCost;
                            break;
                        }
                    }
                    
                    resultsHtml += `
                        <tr class="border-b" style="border-color: var(--border-color);">
                            <td class="p-2 font-bold">${k}-Teams (${numCombos} bets)</td>
                            <td class="p-2 text-center">$${totalCost.toFixed(2)}</td>
                            <td class="p-2 text-center font-bold ${winsNeeded === -1 ? 'text-red-500' : 'text-green-500'}">
                                ${winsNeeded !== -1 ? `${winsNeeded} of ${numGames}` : 'Not Possible'}
                            </td>
                             <td class="p-2 text-center ${profitAtBreakEven <= 0 ? '' : 'text-green-500'}">
                                ${winsNeeded !== -1 ? `~ $${profitAtBreakEven.toFixed(2)}` : 'N/A'}
                            </td>
                        </tr>
                    `;
                }

                resultsHtml += `</tbody></table>`;
                comboResultsContainer.innerHTML = resultsHtml;
            }


            // --- EVENT HANDLERS ---
            function updateCardFromSlider(gameIndex, sliderValue) {
                const awayProbPercent = sliderValue / 10;
                const awayInput = document.getElementById(`game-${gameIndex}-away-prob-input`);
                const homeInput = document.getElementById(`game-${gameIndex}-home-prob-input`);
                
                if(document.activeElement !== awayInput) awayInput.value = awayProbPercent.toFixed(1);
                if(document.activeElement !== homeInput) homeInput.value = (100 - awayProbPercent).toFixed(1);
                
                // Find the card element in the DOM to pass it to the calculator
                const card = document.getElementById(`game-${gameIndex}`);
                if (card) {
                    calculateAndDisplayResults(card, gameIndex, awayProbPercent / 100);
                }
                applyFiltersAndSorting();
            }

            function updateCardFromInput(gameIndex, changedInput, otherInput) {
                let value = parseFloat(changedInput.value);
                if (isNaN(value) || value < 0) value = 0;
                if (value > 100) value = 100;

                const slider = document.querySelector(`.prob-slider[data-game-index="${gameIndex}"]`);
                if (changedInput.id.includes('away')) {
                    slider.value = value * 10;
                    otherInput.value = (100 - value).toFixed(1);
                } else { // home changed
                    slider.value = (100 - value) * 10;
                    otherInput.value = (100 - value).toFixed(1);
                }

                // Find the card element in the DOM to pass it to the calculator
                const card = document.getElementById(`game-${gameIndex}`);
                if(card) {
                    calculateAndDisplayResults(card, gameIndex, parseFloat(slider.value) / 1000);
                }
                applyFiltersAndSorting();
            }
            
            function handleResetProbability(e) {
                const gameIndex = e.dataset.gameIndex;
                const slider = document.querySelector(`.prob-slider[data-game-index="${gameIndex}"]`);
                if (slider) {
                    slider.value = slider.dataset.initialValue;
                    slider.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
            function handle50PercentClick(e) {
                 const gameIndex = e.dataset.gameIndex;
                const slider = document.querySelector(`.prob-slider[data-game-index="${gameIndex}"]`);
                if (slider) {
                    slider.value = 500;
                    slider.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
            function handleCopyClick() {
                let textToCopy = "Audit the Odds - +EV Opportunities\n\n";
                gameCardElements.forEach((card) => {
                     if (card.dataset.positiveEv === 'true') {
                        const gameIndex = card.dataset.gameIndex;
                        const game = ALL_SPORTS_DATA[gameIndex];
                        const awayTeamInfo = getTeamInfo(game.away_team);
                        const homeTeamInfo = getTeamInfo(game.home_team);
                        textToCopy += `------------------------------\n${awayTeamInfo.name} vs. ${homeTeamInfo.name}\n`;
                        card.querySelectorAll('.positive-ev').forEach(resultEl => {
                            const winnerName = resultEl.querySelector('strong').textContent;
                            const evText = resultEl.querySelector('span.font-bold').textContent;
                            
                            let probabilityText = '';
                            if(winnerName.includes(awayTeamInfo.name)) {
                                probabilityText = document.getElementById(`game-${gameIndex}-away-prob-input`).value;
                            } else if (winnerName.includes(homeTeamInfo.name)) {
                                 probabilityText = document.getElementById(`game-${gameIndex}-home-prob-input`).value;
                            } else {
                                 const sliderVal = document.querySelector(`.prob-slider[data-game-index="${gameIndex}"]`).value;
                                 probabilityText = `${(sliderVal/10).toFixed(1)}%`;
                            }
                            textToCopy += `WINNER: ${winnerName} (EV: ${evText}) | Your Prob: ${probabilityText}%\n`;
                        });
                        textToCopy += "\n";
                       }
                });
                copyToClipboard(textToCopy, copyBtnText, 'Copy +EV Games');
            }
            function handleGenerateParlayClick() {
                const strategies = {};
                document.querySelectorAll('.strategy-select').forEach(select => {
                    strategies[select.dataset.sport] = select.value;
                });

                const primaryPicks = [];
                const fillerPicks = [];
                const usedGameIndices = new Set();
                const PARLAY_CAP = 20;

                // Step 1: Find all +EV moneyline picks based on strategy
                ALL_SPORTS_DATA.forEach((game, index) => {
                    const sport = getGameSport(game);
                    const strategy = strategies[sport];
                    if (strategy === 'ignore' || !game.moneyline_away || !game.moneyline_home) return;

                    const awayEV = calculateEV(0.5, game.moneyline_away);
                    const homeEV = calculateEV(0.5, game.moneyline_home);

                    let predictedWinner;
                    if (awayEV > 0 && homeEV > 0) { predictedWinner = awayEV > homeEV ? 'away' : 'home'; } 
                    else if (awayEV > 0) { predictedWinner = 'away'; } 
                    else if (homeEV > 0) { predictedWinner = 'home'; } 
                    else { return; } // No +EV moneyline at 50/50

                    usedGameIndices.add(index);
                    const predictedLoser = predictedWinner === 'away' ? 'home' : 'away';
                    const finalPickTeam = (strategy === 'take') ? predictedWinner : predictedLoser;
                    const pickTeamInfo = getTeamInfo(game[`${finalPickTeam}_team`]);

                    primaryPicks.push({
                        matchup: `${getTeamInfo(game.away_team).name} vs. ${getTeamInfo(game.home_team).name}`,
                        pick: pickTeamInfo.name,
                        justification: `(${strategy === 'take' ? 'Take' : 'Fade'} ${sport} Winner)`
                    });
                });

                // Step 2: Find the best O/U picks from the remaining games
                const slotsToFill = PARLAY_CAP - primaryPicks.length;
                if (slotsToFill > 0) {
                    ALL_SPORTS_DATA.forEach((game, index) => {
                        if (usedGameIndices.has(index)) return; // Skip if already used
                        if (!game.total_over_odds || !game.total_under_odds) return; // Skip if no total odds

                        const overEV = calculateEV(0.5, game.total_over_odds);
                        const underEV = calculateEV(0.5, game.total_under_odds);

                        if (overEV > underEV) {
                            fillerPicks.push({ ev: overEV, pick: `Over ${game.total_over}`, matchup: `${getTeamInfo(game.away_team).name} vs. ${getTeamInfo(game.home_team).name}` });
                        } else {
                            fillerPicks.push({ ev: underEV, pick: `Under ${game.total_under}`, matchup: `${getTeamInfo(game.away_team).name} vs. ${getTeamInfo(game.home_team).name}` });
                        }
                    });

                    fillerPicks.sort((a, b) => b.ev - a.ev);
                    const bestFillers = fillerPicks.slice(0, slotsToFill).map(p => ({
                        ...p,
                        justification: '(Best O/U Pick)'
                    }));
                    primaryPicks.push(...bestFillers);
                }
                
                if (primaryPicks.length === 0) {
                    parlayBtnText.textContent = 'No Picks Found';
                    setTimeout(() => { parlayBtnText.textContent = 'Apply Strategy & Copy Parlay'; }, 2500);
                    return;
                }
                
                // Instead of copying, show the modal
                parlayRationaleContainer.style.display = 'none';
                parlayRationaleContainer.innerHTML = '';
                generateRationaleBtn.style.display = 'block';
                generateRationaleBtn.disabled = false;
                generateRationaleBtn.innerHTML = '✨ Generate Parlay Rationale';
                parlayListContainer.innerHTML = '';
                primaryPicks.slice(0, PARLAY_CAP).forEach(pick => {
                    const pickElement = document.createElement('div');
                    pickElement.className = 'p-3 rounded-lg text-sm';
                    pickElement.style.backgroundColor = 'var(--input-bg)';
                    pickElement.innerHTML = `
                        <p class="font-semibold">${pick.matchup}</p>
                        <p style="color: var(--accent-color);"><strong>PICK:</strong> ${pick.pick} <span class="text-xs font-normal" style="color: var(--text-secondary);">${pick.justification}</span></p>
                    `;
                    parlayListContainer.appendChild(pickElement);
                });

                parlayModal.dataset.picks = JSON.stringify(primaryPicks.slice(0, PARLAY_CAP));
                showParlayModal();
            }

            function showParlayModal() {
                 parlayModal.classList.remove('hidden');
                 setTimeout(() => { 
                    parlayModal.classList.remove('opacity-0');
                    parlayModalContent.classList.remove('scale-95');
                }, 10);
            }

            function hideParlayModal() {
                parlayModal.classList.add('opacity-0');
                parlayModalContent.classList.add('scale-95');
                setTimeout(() => parlayModal.classList.add('hidden'), 300);
            }

            function copyToClipboard(text, buttonTextElement, originalText) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    buttonTextElement.textContent = 'Copied!';
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    buttonTextElement.textContent = 'Copy Failed';
                }
                document.body.removeChild(textArea);
                setTimeout(() => { buttonTextElement.textContent = originalText; }, 2000);
            }

            function copyHtmlToClipboard(html, buttonTextElement, originalText) {
                // Create a temporary element to hold the HTML
                const tempEl = document.createElement('div');
                tempEl.style.position = 'absolute';
                tempEl.style.left = '-9999px';
                tempEl.innerHTML = html;
                document.body.appendChild(tempEl);

                // Select the content of the element
                const range = document.createRange();
                range.selectNodeContents(tempEl);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                // Copy the selection to the clipboard
                try {
                    document.execCommand('copy');
                    buttonTextElement.textContent = 'Copied!';
                } catch (err) {
                    console.error('Failed to copy HTML: ', err);
                    buttonTextElement.textContent = 'Copy Failed';
                }

                // Clean up
                selection.removeAllRanges();
                document.body.removeChild(tempEl);
                setTimeout(() => { buttonTextElement.textContent = originalText; }, 2000);
            }
            
            async function getGameAnalysis(button) {
                 if (!geminiApiKey || geminiApiKey === 'REPLACE_WITH_YOUR_API_KEY') {
                    showError("Please add your Gemini API Key to the `index.html` file to use this feature.", true);
                    button.textContent = "API Key Missing";
                    button.disabled = true;
                    return;
                }

                const { gameIndex, awayTeam, homeTeam, sport } = button.dataset;
                const analysisContainer = document.getElementById(`game-${gameIndex}-analysis-container`);

                button.disabled = true;
                button.innerHTML = `
                    <svg class="spinner h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    Analyzing...
                `;
                analysisContainer.style.display = 'block';
                analysisContainer.innerHTML = '';
                
                const prompt = `Provide a comparative analysis for the upcoming ${sport} game between ${awayTeam} (away) and ${homeTeam} (home). Rate each team from 1 (weak) to 10 (strong) in four distinct categories: "Offense", "Defense", "Recent Form", and "Injury Impact" (a lower score means more negative impact from injuries).`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "away_team_ratings": { 
                                    type: "OBJECT",
                                    properties: {
                                        "offense": { "type": "NUMBER" }, "defense": { "type": "NUMBER" }, "recent_form": { "type": "NUMBER" }, "injury_impact": { "type": "NUMBER" }
                                    }
                                },
                                "home_team_ratings": {
                                    type: "OBJECT",
                                    properties: {
                                        "offense": { "type": "NUMBER" }, "defense": { "type": "NUMBER" }, "recent_form": { "type": "NUMBER" }, "injury_impact": { "type": "NUMBER" }
                                    }
                                }
                            },
                        }
                    }
                };
                
                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${errorBody.error.message}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (jsonText) {
                        const analysis = JSON.parse(jsonText);
                        const awayRatings = analysis.away_team_ratings;
                        const homeRatings = analysis.home_team_ratings;
                        const categories = {
                            offense: 'Offense',
                            defense: 'Defense',
                            recent_form: 'Recent Form',
                            injury_impact: 'Injury Impact'
                        };

                        let tableHtml = `
                            <table class="w-full text-sm text-left border-collapse">
                                <thead>
                                    <tr class="border-b" style="border-color: var(--border-color);">
                                        <th class="p-2 font-semibold">Category</th>
                                        <th class="p-2 font-semibold text-center">${awayTeam}</th>
                                        <th class="p-2 font-semibold text-center">${homeTeam}</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        for (const key in categories) {
                            const awayScore = awayRatings[key];
                            const homeScore = homeRatings[key];
                            const awayStar = awayScore > homeScore ? ' <span class="text-yellow-500">⭐</span>' : '';
                            const homeStar = homeScore > awayScore ? ' <span class="text-yellow-500">⭐</span>' : '';

                            tableHtml += `
                                <tr class="border-b" style="border-color: var(--border-color);">
                                    <td class="p-2 font-medium">${categories[key]}</td>
                                    <td class="p-2 text-center font-bold">${awayScore.toFixed(1)}${awayStar}</td>
                                    <td class="p-2 text-center font-bold">${homeScore.toFixed(1)}${homeStar}</td>
                                </tr>
                            `;
                        }

                        tableHtml += `</tbody></table>`;
                        analysisContainer.innerHTML = tableHtml;

                    } else {
                        throw new Error("No content received from AI.");
                    }
                } catch (err) {
                    console.error("Gemini API Error:", err);
                    analysisContainer.innerHTML = `Sorry, the AI analysis failed. ${err.message}`;
                } finally {
                    button.style.display = 'none'; // Hide button after it's been used
                }
            }
            
            async function getParlayRationale(picks) {
                 if (!geminiApiKey || geminiApiKey === 'REPLACE_WITH_YOUR_API_KEY') {
                    parlayRationaleContainer.style.display = 'block';
                    parlayRationaleContainer.innerHTML = 'Please add your Gemini API key to use this feature.';
                    return;
                }

                generateRationaleBtn.disabled = true;
                generateRationaleBtn.innerHTML = `
                    <svg class="spinner h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    Generating...
                `;
                parlayRationaleContainer.style.display = 'block';
                parlayRationaleContainer.innerHTML = 'Crafting a compelling argument for your picks...';

                const picksString = picks.map(p => `- ${p.pick} in the ${p.matchup} game. Justification: ${p.justification}`).join('\n');
                const prompt = `Act as a sharp, confident sports betting analyst. I have created a parlay with the following picks:\n\n${picksString}\n\nWrite a short, compelling paragraph (3-4 sentences) that provides a rationale for this parlay. Weave the picks together into a coherent strategy. Make it sound smart and persuasive.`;

                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${errorBody.error.message}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        parlayRationaleContainer.innerHTML = text.replace(/\n/g, '<br>');
                        parlayRationaleContainer.dataset.rationale = text;
                    } else {
                        throw new Error("No content received from AI.");
                    }
                } catch (err) {
                    console.error("Gemini API Error:", err);
                    parlayRationaleContainer.innerHTML = `Sorry, the AI rationale failed. ${err.message}`;
                } finally {
                    generateRationaleBtn.style.display = 'none'; // Hide after use
                }
            }


            function attachEventListeners() {
                gameListContainer.addEventListener('input', e => {
                    if (e.target.classList.contains('prob-slider')) {
                        updateCardFromSlider(e.target.dataset.gameIndex, parseFloat(e.target.value));
                    }
                });
                gameListContainer.addEventListener('change', e => {
                    if (e.target.classList.contains('prob-input')) {
                        const gameIndex = e.target.closest('.game-card').dataset.gameIndex;
                        const awayInput = document.getElementById(`game-${gameIndex}-away-prob-input`);
                        const homeInput = document.getElementById(`game-${gameIndex}-home-prob-input`);
                        if (e.target.id === awayInput.id) {
                            updateCardFromInput(gameIndex, awayInput, homeInput);
                        } else {
                            updateCardFromInput(gameIndex, homeInput, awayInput);
                        }
                    }
                });

                gameListContainer.addEventListener('click', e => {
                    if (e.target.closest('.reset-prob-btn')) { handleResetProbability(e.target.closest('.reset-prob-btn')); }
                    if (e.target.closest('.fifty-fifty-btn')) { handle50PercentClick(e.target.closest('.fifty-fifty-btn')); }
                    const analysisBtn = e.target.closest('.get-analysis-btn');
                    if (analysisBtn) {
                        getGameAnalysis(analysisBtn);
                    }
                    const betOption = e.target.closest('.bet-option');
                    if (betOption) {
                        handleBetClick(betOption);
                    }
                });
            }

            // --- SETUP LISTENERS ---
            evFilterToggle.addEventListener('change', applyFiltersAndSorting);
            sortSelect.addEventListener('change', applyFiltersAndSorting);
            copyBtn.addEventListener('click', handleCopyClick);
            addBestEvBtn.addEventListener('click', handleAddBestEVBets);
            generateParlayBtn.addEventListener('click', handleGenerateParlayClick);
            analyzeTodayBtn.addEventListener('click', fetchAndAnalyzeGames);
            newAnalysisBtn.addEventListener('click', resetApp);
            helpBtn.addEventListener('click', () => {
                helpModal.classList.remove('hidden');
                setTimeout(() => { 
                    helpModal.classList.remove('opacity-0');
                    helpModalContent.classList.remove('scale-95');
                }, 10);
            });
            closeHelpModalBtn.addEventListener('click', () => {
                helpModal.classList.add('opacity-0');
                helpModalContent.classList.add('scale-95');
                setTimeout(() => helpModal.classList.add('hidden'), 300);
            });
            
            // Parlay Modal Listeners
            closeParlayModalBtn.addEventListener('click', hideParlayModal);
            cancelParlayBtn.addEventListener('click', hideParlayModal);
            copyParlayBtn.addEventListener('click', () => {
                const picks = JSON.parse(parlayModal.dataset.picks || '[]');
                if (picks.length > 0) {
                    // Define colors for portability (light theme)
                    const colors = {
                        containerBg: '#f1f5f9',
                        accent: '#2563eb',
                        textPrimary: '#0f172a',
                        textSecondary: '#475569',
                        border: '#e2e8f0'
                    };

                    let htmlToCopy = `<div style="font-family: Inter, sans-serif; color: ${colors.textPrimary};">`;
                    htmlToCopy += `<h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">Strategic Parlay Picks (${picks.length} Games)</h3>`;
                    
                    const rationaleText = parlayRationaleContainer.dataset.rationale;
                    if (rationaleText) {
                        htmlToCopy += `<p style="font-size: 14px; margin-bottom: 12px; border-left: 3px solid ${colors.accent}; padding-left: 12px; font-style: italic;">${rationaleText.replace(/\n/g, '<br>')}</p>`;
                    }

                    picks.forEach(pick => {
                        htmlToCopy += `
                            <div style="background-color: ${colors.containerBg}; border-radius: 8px; padding: 12px; font-size: 14px; margin-bottom: 8px; border: 1px solid ${colors.border};">
                                <p style="font-weight: 600; margin: 0 0 4px 0; color: ${colors.textPrimary};">${pick.matchup}</p>
                                <p style="color: ${colors.accent}; margin: 0;">
                                    <strong style="color: ${colors.accent};">PICK:</strong> ${pick.pick}
                                    <span style="font-size: 12px; font-weight: 400; color: ${colors.textSecondary};">${pick.justification}</span>
                                </p>
                            </div>
                        `;
                    });
                    htmlToCopy += `</div>`;

                    copyHtmlToClipboard(htmlToCopy, copyParlayBtnText, 'Copy & Close');
                }
                setTimeout(hideParlayModal, 500); // Give time for "Copied!" text to show
            });

            generateRationaleBtn.addEventListener('click', () => {
                const picks = JSON.parse(parlayModal.dataset.picks || '[]');
                if (picks.length > 0) {
                    getParlayRationale(picks);
                }
            });

             // Bet Slip Listeners
            clearSlipBtn.addEventListener('click', () => {
                betSlip = [];
                // remove all highlights
                document.querySelectorAll('.bet-option').forEach(el => el.style.borderColor = 'transparent');
                renderBetSlip();
            });

            betSlipList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-bet-btn');
                if (removeBtn) {
                    const betIdToRemove = removeBtn.dataset.betId;
                    const betIndex = betSlip.findIndex(b => b.id === betIdToRemove);
                    if(betIndex > -1) {
                        const betToRemove = betSlip[betIndex];
                        const gameCard = document.getElementById(`game-${betToRemove.gameIndex}`);
                        if(gameCard){
                            const betEl = gameCard.querySelector(`.bet-option[data-bet-label="${CSS.escape(betToRemove.label)}"]`);
                            if(betEl) betEl.style.borderColor = 'transparent';
                        }
                        betSlip.splice(betIndex, 1);
                        renderBetSlip();
                    }
                }
            });

             copySlipBtn.addEventListener('click', () => {
                if (betSlip.length > 0) {
                    const colors = {
                        containerBg: '#f1f5f9', accent: '#2563eb', textPrimary: '#0f172a', textSecondary: '#475569', border: '#e2e8f0'
                    };
                    let htmlToCopy = `<div style="font-family: Inter, sans-serif; color: ${colors.textPrimary};">`;
                    htmlToCopy += `<h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">My Bet Slip (${betSlip.length} Picks)</h3>`;
                    betSlip.forEach(bet => {
                        const game = ALL_SPORTS_DATA[bet.gameIndex];
                        const matchup = `${getTeamInfo(game.away_team).name} @ ${getTeamInfo(game.home_team).name}`;
                         const oddsText = bet.odds >= 2 ? `+${((bet.odds - 1) * 100).toFixed(0)}` : `${(-100 / (bet.odds - 1)).toFixed(0)}`;
                        htmlToCopy += `
                            <div style="background-color: ${colors.containerBg}; border-radius: 8px; padding: 12px; font-size: 14px; margin-bottom: 8px; border: 1px solid ${colors.border};">
                                <p style="font-weight: 600; margin: 0 0 4px 0; color: ${colors.textPrimary};">${bet.label} <span style="font-weight: 700; color: ${colors.accent};">(${oddsText})</span></p>
                                <p style="margin: 0; font-size: 12px; color: ${colors.textSecondary};">${matchup}</p>
                            </div>
                        `;
                    });
                    htmlToCopy += `</div>`;
                    copyHtmlToClipboard(htmlToCopy, copySlipBtnText, 'Copy Slip');
                }
            });
            
            // New Combo Modal Listeners
            comboAnalysisBtn.addEventListener('click', () => {
                if (betSlip.length >= 2) {
                    comboModal.classList.remove('hidden');
                    setTimeout(() => {
                        comboModal.classList.remove('opacity-0');
                        comboModalContent.classList.remove('scale-95');
                        calculateAndDisplayComboAnalysis(); // Calculate when opening
                    }, 10);
                }
            });

            const hideComboModal = () => {
                 comboModal.classList.add('opacity-0');
                 comboModalContent.classList.add('scale-95');
                 setTimeout(() => comboModal.classList.add('hidden'), 300);
            };

            closeComboModalBtn.addEventListener('click', hideComboModal);
            wagerPerComboInput.addEventListener('input', calculateAndDisplayComboAnalysis);


        });
    </script>
</body>
</html>



